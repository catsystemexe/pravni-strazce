<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <title>Právní strážce – ANALYSIS run (unknown)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            margin: 2rem;
            line-height: 1.5;
            background: #0f172a;
            color: #e5e7eb;
        }
        pre {
            white-space: pre-wrap;
            word-wrap: break-word;
            background: #020617;
            padding: 1.5rem;
            border-radius: 0.75rem;
            border: 1px solid #1f2937;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        h1 {
            font-size: 1.5rem;
            margin-bottom: 1rem;
        }
        .meta {
            font-size: 0.85rem;
            color: #9ca3af;
            margin-bottom: 0.5rem;
        }
    </style>
</head>
<body>
    <h1>Právní strážce – ANALYSIS run</h1>
    <div class="meta">
      Tento soubor generuje GitHub Action z repozitáře catsystemexe/pravni-strazce.
      (UTC: unknown)
    </div>
    <pre>================================================================================
ODPOVĚĎ CODING AGENTA:

1. Stručné shrnutí (co chápu + hlavní závěry)
- Projekt má už poměrně jasnou architekturu engine → runtime → product, ale data/intents jsou v přechodovém stavu.
- Domény jsou definovány primárně v `data/_source/domains/**`, runtime intenty se ale očekávají v `data/intents/**` (který zatím vůbec neexistuje).
- Traffic law (`traffic_law`) je první doména s plným „novým“ modelem (YAML + poddomény + intents/JSON).
- Loader intentů (`engines/intent/loader.py`) je stále navázaný na starý jednoduchý formát JSONů v `data/intents/**` a nezná `_source`.
- Ve `tools/` existují skripty pro generování/validaci intentů, ale aktuální adresářová struktura (`data/_source/...`) jim částečně „utekla“ a pipeline `_source → data/intents` není dotažená.
- Doménová pravidla (`engines/domain_rules/*.yaml`) jsou paralelní systém vůči `_source/domains` – chybí jednotný „master katalog“.
- Krátkodobě je potřeba: vytvořit minimální `data/intents` pro běh intent enginu a sladit datový model `IntentDefinition` s `_normalize_raw`.
- Střednědobě: formálně zavést build pipeline `_source/domains → data/intents` a ji zadrátovat do tools + dokumentace (`docs/intent.system.md`).
- Dlouhodobě: sjednotit doménový katalog (`domain_rules`, `_source/domains`, `runtime/domain_catalog.py`, `docs/domain_catalog.md`) a vyčistit testy + validace.

---

## 1) DOMÉNY – struktura v `data/_source/domains`

### 1.1 Seznam všech domén (podadresáře `data/_source/domains`)

Pro každou doménu:  
- `domain.yaml`?  
- `subdomains.yaml`?  
- podadresář `intents` + soubory?

1. `administrative_law`
   - `domain.yaml`: ANO (`appeal_admin_decision.json` je vedle, nikoli `domain.yaml`)
   - `subdomains.yaml`: NE
   - `intents/`: NE (je zde pouze `appeal_admin_decision.json` přímo v kořeni)
2. `civil_law`
   - `domain.yaml`: NE
   - `subdomains.yaml`: NE
   - `intents/`: NE
3. `constitutional_law`
   - `domain.yaml`: NE
   - `subdomains.yaml`: NE
   - `intents/`: NE
4. `consumer_finance_law`
   - `domain.yaml`: NE
   - `subdomains.yaml`: NE
   - `intents/`: NE (jen `consumer_credit.json` v kořeni)
5. `corporate_law`
   - `domain.yaml`: NE
   - `subdomains.yaml`: NE
   - `intents/`: NE
6. `criminal_law`
   - `domain.yaml`: NE
   - `subdomains.yaml`: NE
   - `intents/`: NE (jen `criminal_defense.json` v kořeni)
7. `data_digital_law`
   - `domain.yaml`: NE
   - `subdomains.yaml`: NE
   - `intents/`: NE
8. `debt_law`
   - `domain.yaml`: NE
   - `subdomains.yaml`: NE
   - `intents/`: NE
9. `environmental_law`
   - `domain.yaml`: NE
   - `subdomains.yaml`: NE
   - `intents/`: NE
10. `family_law`
    - `domain.yaml`: NE
    - `subdomains.yaml`: NE
    - `intents/`: NE
11. `health_law`
    - `domain.yaml`: NE
    - `subdomains.yaml`: NE
    - `intents/`: NE
12. `inheritance_law`
    - `domain.yaml`: NE
    - `subdomains.yaml`: NE
    - `intents/`: NE
13. `international_law`
    - `domain.yaml`: NE
    - `subdomains.yaml`: NE
    - `intents/`: NE
14. `labor_law`
    - `domain.yaml`: NE
    - `subdomains.yaml`: NE
    - `intents/`: NE (jen `labor_termination.json` v kořeni)
15. `media_ip_law`
    - `domain.yaml`: NE
    - `subdomains.yaml`: NE
    - `intents/`: NE
16. `property_construction_law`
    - `domain.yaml`: NE
    - `subdomains.yaml`: NE
    - `intents/`: NE
17. `school_law`
    - `domain.yaml`: NE
    - `subdomains.yaml`: NE
    - `intents/`: NE
18. `social_law`
    - `domain.yaml`: NE
    - `subdomains.yaml`: NE
    - `intents/`: NE
19. `tax_law`
    - `domain.yaml`: NE
    - `subdomains.yaml`: NE
    - `intents/`: NE
20. `traffic_law`
    - `domain.yaml`: ANO (`data/_source/domains/traffic_law/domain.yaml`)
    - `subdomains.yaml`: ANO
    - `intents/`: ANO (`intents/` se 7 JSON soubory)

### 1.2 Shoda se „plánovaným modelem“ domén

Plánovaný model (podle `docs/README_datova_architektura.md` + `docs/domain_map_traffic_law.md` – obsah sice není celý v promptu, ale z názvů plyne):

- doménová složka nese:
  - `domain.yaml` – metadata domény (název, popis, odkazy na pravidla, mapování na runtime domény),
  - `subdomains.yaml` – hierarchie poddomén a tagů,
  - `intents/*.json` – jednotlivé intent definice v „source“ formátu.

Hodnocení:

- `traffic_law` tento model plně dodržuje → vzorová doména.
- Ostatní domény jsou v „legacy / rozpracovaném“ stavu:
  - jednotlivé JSON soubory leží přímo v kořeni doménové složky, nikoli v `intents/`.
  - chybí `domain.yaml` i `subdomains.yaml`.
  - formát JSONů pravděpodobně odpovídá spíš starému modelu (bez doménových metadat).

Závěr:  
- Model je konzistentně definovaný (viz traffic_law), ale reálně aplikovaný jen na jednu doménu.
- Pro ostatní domény bude potřeba migrační krok: přesun JSONů do `intents/`, doplnění doménových YAML a sjednocení formátu.

---

## 2) INTENTS – loader, cesty, pipeline

### 2.1 Loader pro intenty (`engines/intent/loader.py`)

Klíčové:

- `BASE_DIR = os.path.join(&quot;data&quot;, &quot;intents&quot;)`
- `os.walk(BASE_DIR)` – prochází reálné „runtime“ JSONy.
- `_normalize_raw(raw)`:
  - přejmenuje `id → intent_id`, pokud je přítomno,
  - přidá default prázdné listy pro `keywords` a `negative_keywords`,
  - odstraňuje `intent_group` (explicitně ji maže),
  - whitelisting povolených polí:  
    `intent_id, label_cs, domain, subdomains, description_cs, keywords, negative_keywords, risk_patterns, basic_questions, safety_questions, normative_references, conclusion_skeletons, notes, version`.

Potom `IntentDefinition(**normalized)`.

### 2.2 Model `IntentDefinition` vs loader

`engines/intent/definition.py`:

```py
@dataclass
class IntentDefinition:
    intent_id: str
    label_cs: str
    domain: str
    description_cs: str
    subdomains: List[str]
    keywords: List[str]
    negative_keywords: List[str]
    risk_patterns: List[Dict[str, Any]]
    basic_questions: List[str]
    safety_questions: List[str]
    normative_references: List[str]
    conclusion_skeletons: Dict[str, str]

    notes: str = &quot;&quot;
    version: str = &quot;1.0.0&quot;
    intent_group: str = &quot;general&quot;
    examples: List[str] = field(default_factory=list)
```

Diskrepance:

- `_normalize_raw` explicitně odstraňuje `intent_group`, ale `IntentDefinition` ho má jako field s defaultem.  
  → data z JSON nikdy `intent_group` nepřenášejí; engine si fallbackuje na default „general“.
- `examples` není uvedeno v `valid_fields` → je vždy oříznuto, i kdyby bylo v JSON.  
  → dataclass ho má, ale loader ho nikdy neplní.

To je vnitřně nekonzistentní datový model.

### 2.3 Odkud se mají brát „runtime“ intenty

- Loader používá `data/intents/**` → to je cílová (runtime) složka.
- Skutečná data jsou ale v `data/_source/domains/**`:
  - traffic_law má podadresář `intents/` plus YAML metadata.
  - ostatní domény mají jednotlivé JSONy v kořeni.

Související skripty v `tools/` (podle názvu):

- `generate_intents_from_domains.py` – pravděpodobně má dělat transformaci z `_source/domains` do `data/intents`.
- `generate_intents_from_yaml.py` – starší/alternativní transformace z YAML definic (např. doménové mapy) do JSON intentů.

To ukazuje záměr:

- `_source/*` = master/authoring data (člověkem udržované)
- `data/intents/*` = build artefakty pro runtime `intent_engine`.

### 2.4 Je struktura domén a intentů konzistentní?

Aktuální stav:

- Není přítomen adresář `data/intents` (ve výpisu ho nevidím).
- `intent_engine` při volání `load_intents()` dostane prázdný seznam nebo vyhodí chybu, pokud složka neexistuje (os.walk na neexistující složce vrátí nic → prázdný seznam, takže engine běží, ale bez jakýchkoli definic → předvolený fallback intent „general“, domain „unknown“).
- `_source` struktura není propojená s runtime částí žádným zadrátovaným krokem – chybí jasný build krok v dokumentaci a CI.

Závěr:

- Pipeline `_source/domains → data/intents` existuje jako koncept (scripts + docs), ale není technicky ani procesně dotažená.
- Model `IntentDefinition` a `_normalize_raw` jsou částečně rozjeté (viz `intent_group`, `examples`).
- Konsistence traffic_law vs ostatní domény není zajištěná (jen traffic_law odpovídá plánovanému vzoru).

---

## 3) NÁSTROJE – skripty v `tools/`

### 3.1 `tools/validate_data.py`

Z názvu a struktury projektu:

- Má pravděpodobně:
  - validovat schémata domén (`data/schema/domains.json`) vůči `data/_source/domains/**`.
  - kontrolovat, zda `_source` data odpovídají definovanému JSON schema a naming conventions.
- Vstupy:
  - typicky `data/_source/**` + `data/schema/**`.
- Výstupy:
  - chyby na stdout/exit code, případně report.
- Pravděpodobný stav:
  - ČÁSTEČNĚ POUŽITELNÝ / MIX – ale nemáme obsah, takže:
    - není zřejmé, jestli zná „nový“ model traffic_law,
    - není zřejmé, jestli očekává `data/intents` nebo jen `_source`.

### 3.2 `tools/generate_intents_from_domains.py`

- Co má dělat:
  - Projít `data/_source/domains/**` (včetně `traffic_law` a dalších domén).
  - Z `domain.yaml`, `subdomains.yaml` a jednotlivých JSONů v `intents/` (nebo v kořeni) sestavit plnohodnotné runtime intent JSONy pro `data/intents/**`.
  - Tedy aplikovat:
    - mapping doména → `domain` field v `IntentDefinition`,
    - mapping subdomén → `subdomains` field,
    - generování `keywords`, doplnění `risk_patterns`, atd. dle nějakého zdroje.
- Vstupy:
  - `data/_source/domains/**`, `data/schema/*` (možná).
- Výstupy:
  - soubory v `data/intents/**` (každý intent = jeden JSON).
- Stav:
  - pravděpodobně ČÁSTEČNĚ PŘIZPŮSOBEN starému modelu; traffic_law je první doména využívající nový pattern a skript možná ještě není aktualizován.

### 3.3 `tools/generate_intents_from_yaml.py`

- Co má dělat:
  - Z YAML souborů (dřívější forma zápisu intentů nebo domain map) generovat JSON intentů (možná starší generace před `_source/domains`).
- Vstupy:
  - nějaké YAML definice domén/intents – možná `engines/domain_rules/*.yaml` nebo starší soubory v `docs/analysis` / `docs/generic`.
- Výstupy:
  - JSONy v `data/intents/**` nebo `_source/intents`.
- Stav:
  - pravděpodobně LEGACY. Vzhledem k tomu, že hlavní doménová data jsou nyní v `data/_source/domains/**` a ne v YAML souborech s intenty.

### 3.4 `tools/render_report_to_html.py`

- Nesouvisí přímo s doménami/intenty.
- Co má dělat:
  - z Markdown reportů (např. `out/last_report.md`) generovat HTML (report pro lidi).
- Stav:
  - pravděpodobně OK, nezávislé na změnách domén.

### 3.5 `tools/apply_policy.py`

- Co má dělat:
  - aplikovat nějakou „policy“ (pravděpodobně `prompts/policy` nebo product policy) na data/testy.
- Nesouvisí přímo se strukturou domén, spíše s LLM/engines.
- Stav:
  - není možné posoudit bez obsahu, ale strukturálně není navázán na `_source`.

### 3.6 `tools/validate_intents.py`

- Co má dělat:
  - Validovat obsah `data/intents/**` vůči datové třídě `IntentDefinition` a/nebo JSON schema:
    - povinná pole (`intent_id`, `domain`, `label_cs`…),
    - typy `keywords: list[str]`, `basic_questions: list[str]`, atd.
- Vstupy:
  - `data/intents/**` (runtime data).
- Výstupy:
  - výpis chyb, exit code pro CI.
- Stav:
  - Pokud `data/intents` ještě neexistuje, skript bude mít minimální použití; test `tests/test_generate_intents_from_yaml.py` ukazuje, že tam je aspoň nějaký test stagovaného procesu, ale aktuální architektura `_source/domains` není plně zadrátovaná.

---

## 4) Vyhodnocení a doporučení

### 4.1 Stav: OK / MIX / BROKEN

**OK:**
- `engines/intent/engine.py`:
  - funguje i s prázdnou sadou intentů (vrací defaultní hodnoty) – nezboří pipeline.
  - jasně definuje, že runtime data se načítají z `data/intents/**`.
- `traffic_law` doména:
  - má vzorovou strukturu `domain.yaml + subdomains.yaml + intents/`.
- LLM vrstva + orchestrator:
  - nejsou blokér pro práci s intenty.

**MIX (částečně hotové / nekonzistentní):**
- Datový model IntentDefinition vs `_normalize_raw`:
  - některá pole jsou v dataclass, ale jsou oříznuta loaderem (`examples`, `intent_group`).
- Domény:
  - `traffic_law` odpovídá cílovému modelu, ostatní domény používají starší/meziformát.
- Nástroje:
  - existují generátory/validátory, ale nejsou zjevně přepnuté na nový `_source/domains` model (musí se ověřit v kódu).
- Dokumentace:
  - existují `docs/intent.system.md`, `docs/domain_map_traffic_law.md`, `docs/README_datova_architektura.md`, ale chybí explicitní „build krok“:  
    `python tools/generate_intents_from_domains.py → data/intents`.

**BROKEN / MISSING:**
- `data/intents/**` adresář:
  - chybí runtime JSONy, na které je navázán `intent_engine`.  
  - výsledek: engine běží, ale bez reálné klasifikace (pouze fallback).
- Jednoznačná pipeline `_source → data/intents`:
  - není kodifikovaná (chybí standardní make/poetry script, chybí zmínka v README).
- Jednotný doménový katalog:
  - `engines/domain_rules/*.yaml` vs `data/_source/domains/**` vs `runtime/domain_catalog.py` – více zdrojů pravdy.

---

## 5) Konkrétní doporučené kroky (s prioritou)

### 5.1 Krátkodobé (rychlé fixy, aby šly používat intenty)

1. **Vytvořit minimální `data/intents` pro traffic_law**
   - Pro účely funkční klasifikace:
     - zkopírovat nebo vygenerovat (ručně/skriptem) JSONy z `data/_source/domains/traffic_law/intents/*.json` do `data/intents/traffic_law/*.json`.
     - přizpůsobit je formátu očekávanému `IntentDefinition` + `_normalize_raw`:
       - mít vždy: `intent_id`, `label_cs`, `domain` (např. `&quot;traffic_law&quot;`), `description_cs`, `subdomains` (list), `keywords`, `negative_keywords`, `risk_patterns`, `basic_questions`, `safety_questions`, `normative_references`, `conclusion_skeletons`.
       - zkontrolovat, že žádná další pole nejsou dropnuta neúmyslně.
   - Cíl: `intent_engine` začne vracet smysluplné domény/intent pro provozní testování.

2. **Srovnat `IntentDefinition` a `_normalize_raw`**
   - Rozhodnout:
     - buď chceme `intent_group` a `examples` používat → doplnit je do `valid_fields` a NEodstraňovat `intent_group`,
     - nebo je nechceme → odstranit je z dataclass.
   - Doporučení:
     - `intent_group` je důležitý (řazení typů intentů), takže:
       - zrušit `raw.pop(&quot;intent_group&quot;)` a přidat `&quot;intent_group&quot;` + `&quot;examples&quot;` do `valid_fields`.
   - Tím se sjednotí datový model.

3. **Doplnit jednoduchý krok do README / docs**
   - Do `docs/intent.system.md` nebo hlavního README přidat:
     - „Pro generování runtime intentů spuštěte:  
       `python tools/generate_intents_from_domains.py`  
       což vytvoří/aktualizuje `data/intents/**`.“
   - I kdyby skript zatím podporoval jen `traffic_law`, bude jasné, jaký je zamýšlený proces.

4. **Sanity check loaderu na prázdnou složku**
   - Ověřit (ručně/pytest), že `load_intents()` korektně vrací prázdný seznam i v případě, že `data/intents` zatím neexistuje (a případně ošetřit výjimku `FileNotFoundError` – obalit `os.walk`).
   - Přidat krátkou poznámku do kódu, že prázdný seznam je očekávané chování.

### 5.2 Střednědobé (sjednocení datového modelu, pipeline `_source → data/intents`)

5. **Formálně zavést build pipeline `_source/domains → data/intents`**
   - Zrevidovat `tools/generate_intents_from_domains.py`:
     - vstup: `data/_source/domains/&lt;domain&gt;/domain.yaml`, `subdomains.yaml`, `intents/*.json`,
     - výstup: `data/intents/&lt;domain&gt;/*.json` již ve formátu odpovídajícím `IntentDefinition` (vč. `keywords`, `risk_patterns` atd.).
   - Definovat v něm:
     - jednotné mapování názvů domén (`traffic_law`, `labor_law`, …) na `domain` field v intentu,
     - jak se generují/plní `subdomains` (např. string IDs z `subdomains.yaml`).
   - Přidat CLI interface:
     - `python tools/generate_intents_from_domains.py --domain traffic_law`
     - `python tools/generate_intents_from_domains.py --all`.

6. **Migrovat ostatní domény na „traffic_law model“**
   - Pro každou doménu v `data/_source/domains`:
     - vytvořit `domain.yaml` (minimálně s `id`, `label_cs`, `description_cs`),
     - vytvořit `subdomains.yaml` (i kdyby zatím jen plochý seznam),
     - přesunout existující JSONy (např. `labor_termination.json`) do `intents/` podadresáře.
   - Přizpůsobit formát těchto JSONů tak, aby:
     - obsahovaly pole očekávaná `IntentDefinition`,
     - byly kompatibilní s generátorem do `data/intents`.

7. **Sepis „master doménového katalogu“**
   - V `data/schema/domains.json` a `docs/domain_catalog.md`:
     - zajistit, že seznam domén odpovídá adresářům v `data/_source/domains/**`.
   - Dále:
     - zkontrolovat `runtime/domain_catalog.py` (není v promptu, ale pravděpodobně existuje logika mapování domén),
     - sjednotit názvy a IDs domén (žádné duplikace ani odlišné slugy).

8. **Zrevidovat a sjednotit nástroje:**
   - `generate_intents_from_yaml.py`:
     - rozhodnout, zda:
       - úplně odstranit (pokud už není potřeba), nebo
       - označit jako `legacy` v docstringu + v README.
   - `validate_intents.py`:
     - aktualizovat, aby validoval přesně ten formát, který vyrábí `generate_intents_from_domains.py` (a který očekává `IntentDefinition`).
   - `validate_data.py`:
     - rozšířit, aby kontroloval i konzistenci mezi `domain.yaml`, `subdomains.yaml` a reálnými intent JSONy v `intents/`.

### 5.3 Dlouhodobé (testy, dokumentace, refaktoring)

9. **Vyčistit a rozšířit testy kolem intentů**
   - Přidat:
     - unit test pro `load_intents()` s reálným minimálním datovým vzorkem (např. traffic_law).
     - integrační test:  
       1) zavolá `generate_intents_from_domains.py` na testovací `_source` data,  
       2) zavolá `load_intents()`,  
       3) ověří, že data jsou konzistentní a že `intent_engine.run()` klasifikuje jednoduché dotazy do očekávaných intentů.
   - Test `tests/test_generate_intents_from_yaml.py`:
     - přehodnotit – pokud je to legacy pipeline, buď ji zahodit, nebo adaptovat na nový standard.

10. **Lepší dokumentace datové architektury**
   - Aktualizovat `docs/README_datova_architektura.md` a `docs/intent.system.md`:
     - explicitní diagram:
       - `_source/domains/&lt;domain&gt;/{domain.yaml, subdomains.yaml, intents/*.json}`  
       → `tools/generate_intents_from_domains.py`  
       → `data/intents/&lt;domain&gt;/*.json`  
       → `engines/intent/loader.load_intents()` → `IntentDefinition`.
     - popsat, kde se definují:
       - `keywords` (jen v intent JSON),
       - `subdomains` (z `subdomains.yaml`, jak se propisují do intentů),
       - vztah na `engines/domain_rules/*.yaml` (pravidla vs. intenty).

11. **Sjednotit doménová pravidla s doménovým katalogem**
   - `engines/domain_rules/*.yaml` reprezentují pravidla pro runtime domény (civil, rodinne, spravni, …).  
   - Doporučený cíl:
     - `domain.yaml` jednotlivých domén by měl obsahovat odkaz/název na odpovídající `domain_rules` subset.
     - `runtime/domain_catalog.py` by měl číst společný katalog a z něj:
       - generovat mapování pro domain classification,
       - referencovat `domain_rules`.
   - Tím získáte jednotný zdroj pravdy:
     - „jaké domény existují“,  
     - „jaké mají subdomény“,  
     - „jaké mají intenty“,  
     - „jaká pravidla se na ně vztahují“.

12. **Dlouhodobý refaktoring loaderu**
   - Zvážit:
     - Nepoužívat „ruční“ `_normalize_raw` + `valid_fields`, ale:
       - buď Pydantic modely s validací a defaulty,
       - nebo JSON schema validaci před načtením.
   - Cíl:
     - transparentně vidět, co je povinné a co volitelné,  
     - při přidání nového pole (např. `examples`) mít jeden centrální bod úpravy.

---

### Co mi chybí / co by bylo dobré doplnit pro další iteraci analýzy

- Obsah souborů:
  - `tools/generate_intents_from_domains.py`
  - `tools/generate_intents_from_yaml.py`
  - `tools/validate_intents.py`
  - `runtime/domain_catalog.py`
  - `docs/intent.system.md`, `docs/README_datova_architektura.md`, `docs/domain_catalog.md`, `docs/domain_map_traffic_law.md`
- Ukázkový obsah jednoho `_source` intentu mimo traffic_law (např. `labor_termination.json`) – ověření, jak moc se liší od očekávaného `IntentDefinition`.

Jakmile tyto soubory budou k dispozici, lze:

- přesně navrhnout rozhraní pro generátor `generate_intents_from_domains.py`,
- navrhnout JSON schema pro intent definice,
- vytvořit konkrétní checklist migrace pro každou doménu.
================================================================================
</pre>
</body>
</html>
