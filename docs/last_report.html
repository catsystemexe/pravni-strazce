<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <title>Právní strážce – poslední report agenta</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
    
        body {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            margin: 2rem;
            line-height: 1.5;
            background: #0f172a;
            color: #e5e7eb;
        }
        pre {
            white-space: pre-wrap;
            word-wrap: break-word;
            background: #020617;
            padding: 1.5rem;
            border-radius: 0.75rem;
            border: 1px solid #1f2937;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        h1 {
            font-size: 1.5rem;
            margin-bottom: 1rem;
        }
        .meta {
            font-size: 0.85rem;
            color: #9ca3af;
            margin-bottom: 0.5rem;
        }

    </style>
</head>
<body>
    <h1>Právní strážce – poslední report agenta</h1>
    <div class="meta">
      Tento soubor generuje GitHub Action z repozitáře catsystemexe/pravni-strazce.
    </div>
    <pre>================================================================================
ODPOVĚĎ CODING AGENTA:

## 1. Co chápu ze struktury projektu

1. **Celková architektura**
   - Jádro tvoří `runtime/orchestrator.py` a jednotlivé enginy v `engines/`.
   - Doménová/intent logika je **data‑driven**: JSON/yaml v `data/` + enginy, které nad tím dělají klasifikaci a IRAC skeleton (`engines/core_legal`).
   - LLM je zabalené v `llm/` s konfigem v `llm/config.yaml`, defaultně běží **mock**, real OpenAI jen při `LLM_BACKEND=openai`.

2. **Domény**
   - High‑level domény jsou popsány ve `data/schema/domains.json` a v YAML pro domain_rules (`engines/domain_rules/*.yaml`).
   - Každá doména má navíc **detailnější strukturu** v `data/_source/domains/&lt;domain&gt;/` (např. `administrative_law/appeal_admin_decision.json`, `criminal_law/criminal_defense.json` atd.).
   - Pro **traffic law** existuje vlastní složka:
     - `data/_source/domains/traffic_law/domain.yaml` – hlavní metadata/doménová definice.
     - `data/_source/domains/traffic_law/subdomains.yaml` – strom poddomén (přestupky, provoz, sankce…).
     - `data/_source/domains/traffic_law/readme.md` – doménová dokumentace.
     - `data/_source/domains/traffic_law/intents/*.json` – zdrojové intent definice v této doméně, včetně konkrétní skupiny „traffic_speed_offense_*“.
   - Z `_source/domains` se pravděpodobně generují **produkční intent JSONy** do `data/intents/&lt;domain&gt;/` pomocí nástrojů v `tools/` (`generate_intents_from_yaml.py`, `bootstrap_traffic_law_intents.py`, atd.).

3. **Intent systém**
   - Formální schéma intentu je v `engines/intent/definition.py` (`IntentDefinition`).
   - `engines/intent/loader.py` načítá **všechny** JSONy z `data/intents/**` a normalizuje je:
     - `id` → `intent_id`,
     - doplní `keywords` a `negative_keywords` pokud chybí,
     - zahodí neznáme klíče (srovnává s whitelistem `valid_fields`).
   - `engines/intent/engine.py`:
     - pomocí `_heuristic_classify` provádí **heuristickou klasifikaci** na základě `keywords/negative_keywords`,
     - vrací `intent`, `domain`, `intent_group`, `confidence` a raw skóre,
     - při nízké jistotě a backendu `openai` může volitelně použít LLM (zatím s fixním system promptem).

4. **Dokumentace a nástroje**
   - `docs/intent.system.md` – high‑level popis, jak funguje intent systém (předpokládám včetně pipeline `_source → data/intents`).
   - `docs/domain_map_traffic_law.md` – specificky mapování pro dopravní právo (tj. jak se traffic law doména promítá do intent slovníku).
   - `tools/bootstrap_traffic_law_intents.py` – nástroj pro bootstrap/generaci intentů pro dopravní právo z YAML/šablon.
   - `tools/validate_intents.py`, `tools/validate_data.py`, `tools/generate_intents_from_yaml.py` – kontrola konzistence a generování.

5. **Product / packs / templaty**
   - Product‑specifické konfigurace (`product/e_advokat_pro/*.yaml`) – řízení rizik, licenci, feature flags.
   - `packs/*` – předkonfigurované balíčky domén.
   - `templates/answers/legal_answer_with_judikatura.md` – šablona finální odpovědi (vč. judikatury).
   - `templates/documents/*` – šablony právních dokumentů.

---

## 2. Návrhy konkrétních kroků zaměřených na dopravní právo (traffic law test)

Beru „Traffic law test“ jako cíl: připravit dopravní právo tak, aby:
- bylo konzistentně integrované do doménového katalogu a intent enginu,
- šlo **automaticky testovat**, že traffic intent klasifikace funguje (unit/integration test, zátěžový „test dataset“),
- bylo dobře zdokumentované (doménová mapa + guidelines pro přidávání dalších dopravních intentů).

### 2.1 Architektura a data – sjednocení IntentDefinition vs loader

1. **Sjednotit IntentDefinition a `_normalize_raw`**
   - Problém: `IntentDefinition` obsahuje `intent_group` a `examples`, ale:
     - `_normalize_raw` v `loader.py` přidává `intent_group` do `valid_fields` jen částečně (a současně ho nahoře odstraňuje, viz komentář „pokud nechceš…“ – to je v rozporu s dataclass).
   - Konkrétní kroky:
     1.1. V `loader._normalize_raw`:
         - Rozhodnout, zda `intent_group` je **oficiální pole schématu** (podle `IntentDefinition` ANO).
         - Pokud ano: odstranit pasáž:
           ```python
           if &quot;intent_group&quot; in raw:
               raw.pop(&quot;intent_group&quot;)
           ```
         1.2. Přidat `examples` do `valid_fields`, pokud ještě není (aby bylo možné v intent JSONech mít příklady dotazů).
     1.3. Zkontrolovat, zda `data/_source/domains/traffic_law/intents/*.json` mají `intent_group` a `examples` v konzistentním formátu; případně doplnit.

2. **Zavést explicitní schéma pro `_source` traffic intent JSONy**
   - V `data/_source/_template/intent_template.json` upřesnit:
     - jak se mají pojmenovávat traffic intent ID (`traffic_speed_offense_*`),
     - povinná pole pro dopravní právo – např. pro distinkci: přestupek vs. trestný čin v silniční dopravě (`subdomains`, tagy).
   - Konkrétní kroky:
     2.1. Vytvořit/aktualizovat `_template/intent_template.json` tak, aby obsahoval:
         - `domain`: `&quot;traffic_law&quot;`,
         - `subdomains`: napojené na `subdomains.yaml` (např. `&quot;traffic_speed&quot;`, `&quot;driving_license_points&quot;`, `&quot;accidents_liability&quot;`).
         - `keywords` a `negative_keywords` s příklady pro dopravní kontext (např. `&quot;pokuta za rychlost&quot;`, negativní `&quot;jede vlak&quot;` atd.).
     2.2. V `docs/domain_map_traffic_law.md` doplnit tabulku: `intent_id` ↔ `subdomain` ↔ typ situace ↔ příklady dotazů.

---

### 2.2 Traffic law intents – rozšíření a konzistence

3. **Zkontrolovat a doplnit traffic intents v `_source`**
   - Aktuální seznam (z výpisu):
     - `traffic_speed_offense_police_stop.json`
     - `traffic_speed_offense_dispute_measurements.json`
     - `traffic_speed_offense_abroad.json`
     - `traffic_speed_admin_proceeding.json`
     - `traffic_speed_block_fine.json`
     - `traffic_speed_camera_notice.json`
     - `traffic_speed_offense_generic.json`
   - Vidím jen skupinu „rychlost“. Pro reálný „traffic law test“ je vhodné mít minimálně:
     - alkohol / návykové látky,
     - body a zákaz řízení,
     - dopravní nehody a náhrada škody,
     - parkování / odtah,
     - technický stav vozidla / STK,
     - provoz na dálnici, mýto, známky.
   - Konkrétní kroky:
     3.1. V `data/_source/domains/traffic_law/subdomains.yaml` ověřit, zda tyto oblasti jsou už definované (např. `alcohol_driving`, `driving_license_points`, `parking_towing`).
     3.2. Pokud existují – doplnit odpovídající intent JSONy do `data/_source/domains/traffic_law/intents/`, např.:
         - `traffic_dui_offense_admin_proceeding.json`
         - `traffic_driving_license_points_query.json`
         - `traffic_parking_ticket_dispute.json`
         - `traffic_accident_damage_claim.json`
     3.3. U každého intentu:
         - vyplnit `keywords` pro typické dotazy (např. „jel jsem po nehodě od nehody“ vs. „parkovací lístek“, „bodový systém“),
         - nastavit `negative_keywords`, aby se např. „nehoda“ v jiném než dopravním kontextu nechytala omylem.
     3.4. Použít `tools/bootstrap_traffic_law_intents.py` pro generování základní kostry JSONů (pokud nástroj umí generovat z domény/subdomén; jinak navrhnout upgrade nástroje – viz 6. krok).

4. **Generování do `data/intents/traffic_law`**
   - Předpoklad: pipeline `_source/domains/traffic_law/intents` → `data/intents/traffic_law` je buď:
     - už implementovaná v `tools/generate_intents_from_yaml.py` nebo `tools/generate_intent_from_domains.py`,
     - nebo částečně (je potřeba ji sjednotit).
   - Konkrétní kroky:
     4.1. Zkontrolovat, zda `data/intents/traffic_law` obsahuje JSONy se stejnými ID jako `_source`. Pokud ne:
         - spustit (ručně) vhodný generátor, nebo:
         - doplnit `tools/bootstrap_traffic_law_intents.py`, aby:
           - načetl `data/_source/domains/traffic_law/intents/*.json`,
           - validoval vůči `IntentDefinition`,
           - uložil normalizovanou verzi do `data/intents/traffic_law/*.json`.
     4.2. Po vygenerování spustit `tools/validate_intents.py`, aby se ověřila schémata.

---

### 2.3 Testování – „Traffic law test suite“

5. **Unit test pro intent engine se zaměřením na dopravní právo**
   - Cíl: mít testy, které zkontrolují, že typické dopravní dotazy jsou přiřazeny ke správnému intentu v `traffic_law`.
   - Konkrétní kroky:
     5.1. Vytvořit `tests/test_intent_engine_traffic_law.py` s datově řízenými testy:
         - připravit list strukturovaných test case:
           ```python
           CASES = [
               {
                 &quot;query&quot;: &quot;Jel jsem 70 v obci, policie mě zastavila a dala mi blokovou pokutu, můžu se odvolat?&quot;,
                 &quot;expected_domain&quot;: &quot;traffic_law&quot;,
                 &quot;expected_intent_prefix&quot;: &quot;traffic_speed_offense_block_fine&quot;,
               },
               {
                 &quot;query&quot;: &quot;Přišla mi výzva k uhrazení částky za překročení rychlosti z radaru, co mám dělat?&quot;,
                 &quot;expected_domain&quot;: &quot;traffic_law&quot;,
                 &quot;expected_intent_prefix&quot;: &quot;traffic_speed_camera_notice&quot;,
               },
               ...
           ]
           ```
         - v testu:
           - vytvořit `EngineInput(context={&quot;case&quot;: {&quot;user_query&quot;: query}})`,
           - zavolat `engines.intent.engine.run`,
           - ověřit, že:
             - `payload[&quot;domain&quot;] == expected_domain`,
             - `payload[&quot;intent&quot;].startswith(expected_intent_prefix)` nebo přesná shoda,
             - `payload[&quot;confidence&quot;] &gt;= 0.5` pro „jasné“ scénáře.
     5.2. Přidat i **negativní testy**:
         - dotazy typu „jízdenka na vlak“ nebo „letecká doprava“ by neměly spadnout do `traffic_law` domain (nebo by confidence měla být nízká, `domain` klidně `unknown`).
     5.3. Zaintegrovat testy do existující test sady (`pytest` již běží, 4 passed – doplnit a ověřit, že testy nepadnou).

6. **Datový „test set“ pro traffic law**
   - Pro robustnější testování (i manuální) by se hodil **externí dataset** dopravních dotazů.
   - Konkrétní kroky:
     6.1. Vytvořit např. `data/_source/domains/traffic_law/test_cases.yaml`:
         - každá položka: `query`, `expected_intent`, `expected_domain`, `notes`.
     6.2. Napsat malý nástroj (např. `tools/run_traffic_law_testset.py`):
         - načte YAML,
         - pro každý dotaz spustí intent engine,
         - vypíše tabulku úspěšnosti + nejčastější chybná přiřazení.
     6.3. Později lze tento nástroj zapojit do CI jako „smoke test“ pro traffic law.

---

### 2.4 Šablony a dokumentace – specificky pro traffic law

7. **Doménová mapa a guideline pro traffic law**
   - `docs/domain_map_traffic_law.md` už existuje, ale potřebuje:
     - být pevně navázána na skutečný obsah `data/_source/domains/traffic_law/*`.
   - Konkrétní kroky:
     7.1. V `docs/domain_map_traffic_law.md` u každé subdomény:
         - vypsat existující intent ID,
         - stručný popis (1–2 věty),
         - 2–3 příklady typického dotazu.
     7.2. Přidat sekci „Jak přidat nový traffic intent“:
         - vzorový postup:
           1. přidat `subdomain` do `subdomains.yaml`, pokud ještě není,
           2. vytvořit nový intent JSON v `_source/domains/traffic_law/intents`,
           3. vygenerovat do `data/intents/traffic_law`,
           4. přidat test case do `test_cases.yaml` a do unit testu,
           5. aktualizovat doménovou mapu.

8. **Vazba na šablony odpovědí**
   - `templates/answers/legal_answer_with_judikatura.md` je generická; pro traffic law lze:
     - využít stejné šablony, ale doplnit do IRAC skeletonu typické prvky (např. práce se záznamem v registru řidičů, možnosti opravného prostředku).
   - Konkrétní kroky:
     8.1. V `data/_source/domains/traffic_law/intents/*.json` využít pole `conclusion_skeletons`:
         - pro každý traffic intent definovat kostru odpovědi (např. včetně bullet‑point shrnutí „co zkontrolovat“ – výsledek měření, správnost doručení, lhůty).
     8.2. Ujistit se, že `core_legal/engine.py` tyto skeletony umí použít (typicky podle `intent_id`).

---

## 3. Co není jasné a co bych potřeboval vidět

Abych navrhl ještě přesnější změny:

1. **Obsah traffic domény**
   - `data/_source/domains/traffic_law/domain.yaml`
   - `data/_source/domains/traffic_law/subdomains.yaml`
   - `data/_source/domains/traffic_law/readme.md`
   - alespoň 1–2 ukázky z `traffic_speed_offense_*.json`
   → potřeboval bych je vidět, abych mohl:
   - navrhnout konkrétní strukturu subdomén (např. strom: „Přestupky řidiče“ → „Rychlost“, „Alkohol“ atd.),
   - ověřit, jak přesně jsou definována pole `subdomains`, `risk_patterns`, `normative_references`.

2. **Aktuální obsah `data/intents/traffic_law`**
   - Není z výpisu jasné, zda je tato složka už naplněná konkrétními JSONy, a zda odpovídají `_source`.
   → potřeboval bych výpis souborů + 1 ukázkový JSON z `data/intents/traffic_law`, abych:
   - ověřil, jak vypadá „produkční“ intent,
   - navrhl přesný mapping `_source` → `data/intents` (kde se dělají normalizace/transformace).

3. **Nástroj `tools/bootstrap_traffic_law_intents.py`**
   - Neznám jeho vnitřní logiku.
   → potřeboval bych obsah souboru, abych:
   - viděl, zda generuje z YAML, nebo z doménového popisu,
   - navrhl rozšíření generátoru o nové subdomény / patterny.

4. **Napojení traffic domény do `runtime/domain_catalog.py`**
   - Jak jsou domény evidované a mapované na enginy?
   → bez pohledu na `runtime/domain_catalog.py` a možná `docs/domain_catalog.md` nelze přesně navrhnout změny pro traffic law (např. aliasy typu „dopravní přestupek“, „silniční doprava“).

---

Pokud pošleš tyto konkrétní soubory (nebo relevantní výřezy), můžu:
- přesně navrhnout strukturu subdomén pro dopravní právo,
- připravit vzorové traffic intents (i textově),
- navrhnout konkrétní test cases (včetně negativních),
- a případné úpravy nástrojů v `tools/*.py`.
================================================================================
[fix_create_intent_runtime_dirs] Ensured runtime dirs in: /home/runner/work/pravni-strazce/pravni-strazce/data/intents
  - school_law
  - debt_law
  - environmental_law
  - property_construction_law
  - social_law
  - media_ip_law
  - constitutional_law
  - family_law
  - data_digital_law
  - labor_law
  - health_law
  - tax_law
  - administrative_law
  - inheritance_law
  - criminal_law
  - traffic_law
  - corporate_law
  - civil_law
  - consumer_finance_law
  - international_law
[bootstrap_traffic_law] updated: data/intents/traffic_law/traffic_speed_admin_proceeding.json
[bootstrap_traffic_law] updated: data/intents/traffic_law/traffic_speed_block_fine.json
[bootstrap_traffic_law] updated: data/intents/traffic_law/traffic_speed_camera_notice.json
[bootstrap_traffic_law] updated: data/intents/traffic_law/traffic_speed_offense_abroad.json
[bootstrap_traffic_law] updated: data/intents/traffic_law/traffic_speed_offense_dispute_measurements.json
[bootstrap_traffic_law] updated: data/intents/traffic_law/traffic_speed_offense_generic.json
[bootstrap_traffic_law] updated: data/intents/traffic_law/traffic_speed_offense_police_stop.json
[bootstrap_traffic_law] DONE – updated=7, unchanged=0, source_dir=/home/runner/work/pravni-strazce/pravni-strazce/data/_source/domains/traffic_law/intents
</pre>
</body>
</html>
