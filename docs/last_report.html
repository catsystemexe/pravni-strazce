<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <title>Právní strážce – poslední report agenta</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
    
        body {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            margin: 2rem;
            line-height: 1.5;
            background: #0f172a;
            color: #e5e7eb;
        }
        pre {
            white-space: pre-wrap;
            word-wrap: break-word;
            background: #020617;
            padding: 1.5rem;
            border-radius: 0.75rem;
            border: 1px solid #1f2937;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        h1 {
            font-size: 1.5rem;
            margin-bottom: 1rem;
        }
        .meta {
            font-size: 0.85rem;
            color: #9ca3af;
            margin-bottom: 0.5rem;
        }

    </style>
</head>
<body>
    <h1>Právní strážce – poslední report agenta</h1>
    <div class="meta">
      Tento soubor generuje GitHub Action z repozitáře catsystemexe/pravni-strazce.
    </div>
    <pre>================================================================================
ODPOVĚĎ CODING AGENTA:

## 1. Co chápu ze struktury projektu

- Projekt je jádro backendového frameworku „Právní strážce“.
- Logika je rozdělená do engine modulů (core_legal, judikatura, intent, risk, safety, domain_rules, …), orchestraci řeší `runtime.orchestrator`.
- Domény a intenty:
  - Doménová metadata a zdrojové intent definice jsou v `data/_source/domains/...`.
  - Runtime verze intent definic pro klasifikaci se očekávají v `data/intents/*.json` (to používá `engines/intent/loader.py`).
  - Pro traffic law už existují zdrojové YAML/JSON soubory pod `data/_source/domains/traffic_law/...`.
  - Jsou k dispozici nástroje pro generování / validaci intentů (`tools/generate_intents_from_yaml.py`, `tools/bootstrap_traffic_law_intents.py`, `tools/validate_intents.py` atd.).
- Testy:
  - Existují integrační testy pro orchestrátor, domain_rules, judikaturu, core_legal, ale zatím žádný runtime test pro intent loader.
- `engines/intent/loader.py`:
  - Načítá JSONy z `data/intents/**`.
  - Normalizuje je (_normalize_raw) na strukturu `IntentDefinition`.
- `IntentDefinition` v `engines/intent/definition.py` má pole `domain` i `intent_group`, takže přes něj můžeme kontrolovat doménové pokrytí.

---

## 2. Konkrétní návrh kroků k úkolu (test pro `load_intents()`)

### 2.1. Minimální pomocný skript / runtime ověření

Pro rychlou manuální kontrolu (mimo testy) lze navrhnout jednoduchý skript do `engines/intent/loader.py` jako spustitelný blok pod `if __name__ == &quot;__main__&quot;:`:

1. Na konec `engines/intent/loader.py` přidat:

   ```python
   if __name__ == &quot;__main__&quot;:
       intents = load_intents()
       print(f&quot;Načteno intentů: {len(intents)}&quot;)

       domains = sorted({i.domain for i in intents})
       print(&quot;Domény v načtených intentech:&quot;)
       for d in domains:
           print(f&quot; - {d}&quot;)
   ```

   Tím se dá ručně ověřit:
   - že `load_intents()` vrací nenulový seznam (výpis počtu),
   - kolik intentů načte,
   - jaké hodnoty `domain` existují.

   To je čistě pomocné, nemění chování importu ani testů.

&gt; Pokud nechcete upravovat production kód vůbec, lze totéž udělat jako malý standalone skript v `tools/` (např. `tools/debug_intent_loader.py`) – ale zadání dovoluje doplnit „minimální pomocný skript (nebo test)“, takže blok `__main__` v loaderu je v souladu.

---

### 2.2. Test `tests/test_intent_loader_runtime_minimal.py`

Soubor zatím v testech není, takže navrhuji ho vytvořit / aktualizovat přesně podle zadání:

1. Vytvořit `tests/test_intent_loader_runtime_minimal.py` s tímto obsahem:

   ```python
   from engines.intent.loader import load_intents


   def test_load_intents_basic_runtime():
       # 1) Načtení intentů
       intents = load_intents()

       # 2) Musí vrátit nenulový seznam
       assert isinstance(intents, list)
       assert len(intents) &gt; 0, &quot;load_intents by měl vracet alespoň jeden intent&quot;

       # 3) Získání domén ze všech načtených intentů
       domains = {intent.domain for intent in intents}

       # 4) Musí existovat traffic_law mezi doménami
       assert (
           &quot;traffic_law&quot; in domains
       ), f&quot;Mezi doménami načtených intentů by měla být i &#x27;traffic_law&#x27;, ale domény jsou: {sorted(domains)}&quot;
   ```

   Vysvětlení:
   - Importuje `load_intents` z `engines.intent.loader`.
   - Zavolá `load_intents()`.
   - Assertuje, že:
     - návratová hodnota je list,
     - délka listu &gt; 0.
   - Získá množinu `domain` z načtených `IntentDefinition`.
   - Assertuje, že `&quot;traffic_law&quot;` je v množině domén.
   - Chybová hláška vypíše aktuální domény pro snazší debug, pokud by test selhal (např. pokud nejsou vygenerované `data/intents/traffic_law_*.json`).

2. V rámci CI / lokálně:
   - Před spuštěním testu je potřeba mít vygenerované runtime intent JSONy:
     - buď ručně pomocí vhodného nástroje (např. `python tools/bootstrap_traffic_law_intents.py` nebo `python tools/generate_intents_from_yaml.py` – podle aktuálního workflow projektu),
     - nebo mít už verzované JSONy v `data/intents/`.
   - Pokud se spoléháte jen na `_source`, test by padal; proto je vhodné mít jasně zdokumentováno, že `data/intents` má být součástí repozitáře či build kroku.

---

## 3. Architektura / domény / intents – drobná doporučení vyplývající z úkolu

1. **Jasný „build step“ pro intenty:**
   - V dokumentaci (`docs/intent.system.md` nebo `docs/README_datova_architektura.md`) uveďte sekci:
     - jak se generuje `data/intents` z `data/_source/domains/**`,
     - jaký příkaz je potřeba spustit před testy.
   - Příklad:  
     „Před spuštěním testů: `python tools/generate_intents_from_yaml.py` (nebo odpovídající skript), který vytvoří/aktualizuje `data/intents/*.json`.“

2. **Validace konzistence domén:**
   - Do existujících validačních nástrojů (`tools/validate_intents.py`) doplnit check, že:
     - všechny `IntentDefinition.domain` existují v master seznamu domén (`data/schema/domains.json` nebo runtime/domain_catalog.py),
     - tím se zachytí překlepy a zaručí, že test typu „mezi doménami je traffic_law“ má smysl.

3. **Oddělení runtime vs. source dat:**
   - V dokumentaci krátce vyjasnit:
     - `_source` = autoritativní zdroj (YAML/JSON), vhodný pro editaci domén a intentů,
     - `data/intents` = runtime materializovaná podoba, kterou načítá `intent_engine`.

---

## 4. Co není jasné a co by stálo za upřesnění

1. **Jak přesně vzniká `data/intents`:**
   - Je to:
     - plně verzované v Gitu, nebo
     - generované v CI při build kroku, nebo
     - generované ad-hoc lokálně?
   - Od toho se odvíjí:
     - zda testy mají spoléhat na existující soubory v repozitáři, nebo
     - jestli by měly předem (v `conftest.py` nebo v CI skriptu) volat generovací nástroj.

2. **Kanonický nástroj pro generování traffic_law intentů:**
   - V `tools/` je více skriptů – není zřejmé, který je „ten pravý“ pro traffic_law:
     - `tools/bootstrap_traffic_law_intents.py`
     - `tools/generate_intents_from_yaml.py`
   - Doporučení: v dokumentaci jasně označit:
     - „Toto je hlavní nástroj pro generování runtime intentů ze zdrojových YAML/JSON.“

Pokud tyto dvě věci upřesníte, můžu navrhnout i konkrétní hook do CI / test setupu (bez úprav produkčního kódu), který zajistí, že `tests/test_intent_loader_runtime_minimal.py` bude vždy běhat nad aktuální sadou intentů.
================================================================================
Run type : FIX
Timestamp (UTC) : 2025-11-29T17:13:06Z
Task : Automatický bootstrap intentů pro traffic_law + sanity test
------------------------------------------------------------------------

Vytvořen/aktualizován: tools/bootstrap_traffic_law_intents.py
Vytvořen/aktualizován: tests/test_intent_loader_runtime_minimal.py
Vygenerované/aktualizované runtime intenty v data/intents/traffic_law: (žádné nové, jen přepsáno)
</pre>
</body>
</html>
