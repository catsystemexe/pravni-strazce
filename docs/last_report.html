<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <title>Právní strážce – poslední report agenta</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            margin: 2rem;
            line-height: 1.5;
            background: #0f172a;
            color: #e5e7eb;
        }
        pre {
            white-space: pre-wrap;
            word-wrap: break-word;
            background: #020617;
            padding: 1.5rem;
            border-radius: 0.75rem;
            border: 1px solid #1f2937;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        h1 {
            font-size: 1.5rem;
            margin-bottom: 1rem;
        }
        .meta {
            font-size: 0.85rem;
            color: #9ca3af;
            margin-bottom: 0.5rem;
        }
    </style>
</head>
<body>
    <h1>Právní strážce – poslední report agenta</h1>
    <div class="meta">Tento soubor generuje GitHub Action z repozitáře catsystemexe/pravni-strazce.</div>
    <pre>================================================================================
ODPOVĚĎ CODING AGENTA:

1. Co chápu ze struktury projektu
- Projekt je skeleton jádra „Právní strážce“ s orchestrátorem a sadou enginů (core_legal, judikatura, risk, intent_engine atd.).
- Intent systém má:
  - zdrojová data na úrovni domén v `data/_source/domains/**`,
  - cílové „runtime“ intent JSONy v `data/intents/**`,
  - generovací/validační nástroje v `tools/`,
  - runtime načítání a použití přes `engines/intent/*`.
- Zvláštní doména: `traffic_law` má detailní doménový popis (`domain.yaml`, `subdomains.yaml`) a per‑intent JSONy v `data/_source/domains/traffic_law/intents/*.json`.
- Dokončen je skeleton enginů a orchestrátoru; intent systém je zčásti přepsaný, ale nástroje a data jsou s ním teď v nekonzistentním stavu.

---

## 1. Datový tok (jak by to mělo fungovat)

Očekávaný ideální flow podle kódu, názvů a struktury:

1. **Domény &amp; zdroje (YAML/JSON)**
   - Doménový popis: `data/_source/domains/&lt;domain&gt;/domain.yaml`
   - (Případně) `subdomains.yaml` + další metainformace.
   - Intenty dané domény v surové podobě:
     - buď v jedné YAML/JSON doménové struktuře,
     - nebo jednotlivé soubory v `data/_source/domains/&lt;domain&gt;/intents/*.json`.

2. **Generátor intentů**
   - `tools/generate_intents_from_domains.py`:
     - načte doménové YAML/JSON + per‑intent zdroje,
     - pro každou intent definici složí jednotný JSON podle schématu,
     - výsledky zapíše do `data/intents/&lt;domain&gt;/&lt;intent_id&gt;.json` (nebo podobné struktury).
   - Alternativně/legacy: `tools/generate_intents_from_yaml.py` čte jinou formu YAMLů a generuje do `data/intents/**`.

3. **Validační nástroje**
   - `tools/validate_intents.py`:
     - projde `data/intents/**`,
     - ověří povinná pole (id/intent_id, domain, keywords, negative_keywords, description_cs, …),
     - případně schema podle `data/schema/domains.json` nebo vlastního JSON schématu pro intent.

4. **Runtime načítání**
   - `engines/intent/loader.load_intents()`
     - čte `data/intents/**.json`,
     - volá `_normalize_raw()` pro přizpůsobení JSONu datové třídě `IntentDefinition`,
     - vytváří instance `IntentDefinition(**normalized)`.

5. **Datová reprezentace**
   - `engines/intent/definition.IntentDefinition`:
     - definuje, jaká pole má jednotný „runtime“ intent mít:
       - `intent_id`, `label_cs`, `domain`, `description_cs`, `subdomains`, `keywords`, `negative_keywords`, `risk_patterns`, `basic_questions`, `safety_questions`, `normative_references`, `conclusion_skeletons`, `notes`, `version`, `intent_group`, `examples`.

6. **Intent engine**
   - `engines/intent/engine.py`:
     - načte vše přes `get_intent_definitions()` (cache),
     - heuristicky vyhodnotí text dotazu podle `keywords` a `negative_keywords`,
     - odvodí `intent`, `domain` a `intent_group`,
     - volitelně doplní LLM názor.

---

## 2. Reálný stav (jak to funguje teď)

Na základě viditelného kódu a struktury:

- **Data v `data/intents/**` v repozitáři zatím nejsou vůbec vypsaná** (v dumpu nejsou žádné JSON soubory), takže:
  - `engines/intent/loader.BASE_DIR = &quot;data/intents&quot;` prakticky nenajde žádné soubory,
  - `load_intents()` vrací prázdný seznam,
  - `intent_engine` pak běží s prázdnou sadou intentů (fallback `general`/`unknown`).
- **Zdrojová doména `traffic_law` je nejvíc rozpracovaná:**
  - `data/_source/domains/traffic_law/domain.yaml`
  - `data/_source/domains/traffic_law/subdomains.yaml`
  - `data/_source/domains/traffic_law/intents/*.json`
- K dispozici jsou nástroje:
  - `tools/generate_intents_from_domains.py`
  - `tools/validate_intents.py`
  - `tools/generate_intents_from_yaml.py`
  - ale z popisu uživatele víme, že:
    - `python -m tools.generate_intents_from_domains --domain traffic_law` selhává,
    - některé vygenerované/ručně psané JSONy pro intent selhávaly proti `IntentDefinition` (např. `examples`, chybějící `domain`, rozdíl `id` vs `intent_id`).
- `IntentDefinition` a `_normalize_raw()` se rozchází:
  - `IntentDefinition` stále obsahuje `intent_group` a `examples`,
  - `_normalize_raw()` explicitně `intent_group` maže a `examples` vůbec nepropouští.
- V minulosti byla jiná struktura JSONů (s klíčem `id` a bez `domain` / `keywords`), proto `_normalize_raw()` řeší:
  - `id` → `intent_id`,
  - doplnění prázdných `keywords`/`negative_keywords`,
  - odstranění neznámých polí.

---

## 3. Seznam konkrétních problémů

### 3.1 Rozbitý generátor z domén (`generate_intents_from_domains.py`)

Na základě struktury a popisu chování:

- Příkaz:  
  `python -m tools.generate_intents_from_domains --domain traffic_law`
  
  velmi pravděpodobně:
  - hledá soubor `data/_source/domains/traffic_law.yaml` nebo `traffic_law/domain.json` místo existujícího `domain.yaml`, nebo
  - očekává jiný layout adresářů (např. `data/_source/traffic_law/domain.yaml` bez mezivrstev `domains/`), nebo
  - očekává jiný název podadresáře pro intent zdroje (např. `intents.yaml` vs `intents/*.json`).

Bez přímého obsahu souboru `tools/generate_intents_from_domains.py` a tracebacku mohu formulovat dvě nejpravděpodobnější varianty:

- **Varianta A – špatná cesta k doménovému YAML**  
  Traceback typicky:
  ```text
  File &quot;tools/generate_intents_from_domains.py&quot;, line XX, in &lt;module&gt;
      main()
  File &quot;tools/generate_intents_from_domains.py&quot;, line YY, in main
      with open(domain_path) as f:
  FileNotFoundError: [Errno 2] No such file or directory: &#x27;data/_source/domains/traffic_law.yaml&#x27;
  ```
  Přitom existuje jen `data/_source/domains/traffic_law/domain.yaml`.

- **Varianta B – hledání jediného souboru s intent definicemi**  
  Příklad:
  ```text
  File &quot;tools/generate_intents_from_domains.py&quot;, line AA, in load_domain_intents
      with open(intents_path) as f:
  FileNotFoundError: [Errno 2] No such file or directory: &#x27;data/_source/domains/traffic_law/intents.yaml&#x27;
  ```
  Realita: existuje `data/_source/domains/traffic_law/intents/*.json` (více souborů, ne jeden YAML).

Tj. generátor je napsaný pro jiný datový model domén, než jaký ve `traffic_law` skutečně je.

### 3.2 Nesoulad IntentDefinition vs. JSON data a normalizační logika

- `IntentDefinition` definuje pole:
  - povinná: `intent_id`, `label_cs`, `domain`, `description_cs`, `subdomains`, `keywords`, `negative_keywords`, `risk_patterns`, `basic_questions`, `safety_questions`, `normative_references`, `conclusion_skeletons`,
  - volitelná: `notes`, `version`, `intent_group`, `examples`.
- `_normalize_raw()` povoluje pouze:
  ```python
  valid_fields = {
      &quot;intent_id&quot;,
      &quot;label_cs&quot;,
      &quot;domain&quot;,
      &quot;subdomains&quot;,
      &quot;description_cs&quot;,
      &quot;keywords&quot;,
      &quot;negative_keywords&quot;,
      &quot;risk_patterns&quot;,
      &quot;basic_questions&quot;,
      &quot;safety_questions&quot;,
      &quot;normative_references&quot;,
      &quot;conclusion_skeletons&quot;,
      &quot;notes&quot;,
      &quot;version&quot;,
  }
  ```
  a:
  - `intent_group` explicitně odstraňuje (`if &quot;intent_group&quot; in raw: raw.pop(&quot;intent_group&quot;)`),
  - `examples` vůbec nepouští (bude odfiltrováno v cyklu nad `valid_fields`),
  - `id` přemapuje na `intent_id`.

Důsledky:

- **Chyby při načítání JSONů**:
  - Pokud JSON obsahuje `examples`, v pohodě se načte, protože `_normalize_raw()` přebytečná pole odfiltruje před voláním `IntentDefinition(**normalized)`.  
    Tady tedy výjimka typu „unexpected keyword &#x27;examples&#x27;“ nepochází z loaderu v současné verzi – spíše z minulého stavu, kdy `_normalize_raw()` ještě neexistovalo nebo nemělo whitelist.
  - Pokud JSON neobsahuje `domain`, `keywords`, `negative_keywords`, `risk_patterns` apod., pak:
    - `_normalize_raw()` doplní `keywords` a `negative_keywords` prázdnými seznamy,
    - ale **`domain` a ostatní povinná pole nevyplňuje** → konstruktor `IntentDefinition` spadne na `TypeError: __init__() missing required positional argument: &#x27;domain&#x27;`.
- `intent_group` je v dataclass, ale loader ho maže – takže:
  - `IntentDefinition` je v praxi vždy inicializován s defaultem `intent_group=&quot;general&quot;`,
  - runtime engine sice čte `intent_group` přes `getattr(intent_def, &quot;intent_group&quot;, None)`, ale realitu generátor ignoruje.

### 3.3 Chybějící / nekompletní pole v JSONech

Z popisu uživatele:

- „unexpected keyword &#x27;examples&#x27;“ – starší loader (bez `_normalize_raw()` nebo bez whitelistu) přímo dělal `IntentDefinition(**raw_json)` → `TypeError` na neznámé pole.  
  Nový `_normalize_raw()` toto řeší, ale zároveň `examples` úplně zahazuje – runtime je nemá k dispozici.
- „chybějící domain“ – JSONy generované nebo ručně psané:
  - mohly mít jen `id`, `label_cs`, `description_cs`, `keywords`… bez `domain`,
  - generátor/loader neprovádí doplnění `domain` z cesty nebo z `domain.yaml`,
  - `IntentDefinition` domain vyžaduje.

Potenciálně další problémy (odolnost generátoru/validatoru):

- `subdomains` – v dataclass povinné `List[str]`, ale běžně může chybět.
- `risk_patterns`, `basic_questions`, `safety_questions`, `normative_references`, `conclusion_skeletons` – také povinné, ale doménový YAML nebo zdrojové JSONy je často nemají kompletně vyplněné.

### 3.4 Cesty a adresářová struktura

- Runtime loader čeká:
  - základnu `data/intents/` (relativně k root),
  - rekurzivně JSONy k načtení.
- Zdrojová doména `traffic_law`:
  - data v `data/_source/domains/traffic_law/intents/*.json`,
  - generátor musí tuto cestu znát a zkonvertovat do `data/intents/**`.
- Mismatchy:
  - generátor možná používá jiné kořenové cesty (`data/domains` vs `data/_source/domains`),
  -/nebo jiný layout uvnitř domény (`domain.yaml` vs `&lt;domain&gt;.yaml`, `intents.yml` vs `intents/*.json`).

---

## 4. Návrh oprav – v bodech (bez kódu)

### 4.1 Vyjasnit a sjednotit cílové schéma IntentDefinition vs JSON

1. Rozhodnout, jaká pole jsou v runtime **skutečně povinná**:
   - Minimální jádro: `intent_id`, `label_cs`, `domain`, `description_cs`, `keywords`, `negative_keywords`.
   - `subdomains`, `risk_patterns`, `basic_questions`, `safety_questions`, `normative_references`, `conclusion_skeletons` udělat volitelná (defaulty v dataclass).
2. Podle této volby:
   - doplnit defaulty v `IntentDefinition` pro pole, která mohou chybět,
   - nebo v `_normalize_raw()` důsledně doplňovat prázdné struktury (`[]` nebo `{}`) pro chybějící položky.
3. Rozhodnout o `intent_group` a `examples`:
   - pokud je chceme v runtime používat:
     - přidat je do `valid_fields` v `_normalize_raw()`,
     - přestat `intent_group` mazat v `_normalize_raw()`,
     - doplnit jejich generování ve `generate_intents_from_domains.py` (např. `examples` z doménových zdrojů).
   - pokud ne:
     - odstranit je z `IntentDefinition` a z testů/dokumentace, aby nebyl dvojí standard.

### 4.2 Oprava `_normalize_raw()` tak, aby odpovídala dataclass

4. V `_normalize_raw()`:
   - `valid_fields` zarovnat s finální podobou `IntentDefinition`,
   - přidat případné defaulty/doplnění:
     - pokud chybí `subdomains`: doplnit na `[]`,
     - pokud chybí `risk_patterns`, `basic_questions`, `safety_questions`, `normative_references`, `conclusion_skeletons`: doplnit na prázdné seznamy/dict,
     - pokud chybí `domain`, ale víme jej z cesty (viz 4.3): doplnit z názvu adresáře.
5. U `examples`:
   - buď je přidat do `valid_fields`, nebo odstranit z dataclass – zabránit „tichému zahazování“.

### 4.3 Ujasnit a opravit cesty v generátoru `generate_intents_from_domains.py`

6. Otevřít `tools/generate_intents_from_domains.py` a zkontrolovat:
   - jak přesně počítá `domain_path` a cestu k intentům pro `traffic_law`,
   - jaké koncovky hledá (`.yaml` vs `.yml` vs `.json`),
   - zda očekává jediný soubor s intent definicemi, nebo umí číst více souborů.
7. Podle aktuální struktury repozitáře nastavit generátor takto:
   - Kořen doménových zdrojů: `data/_source/domains/`.
   - Pro doménu `traffic_law`:
     - hlavní doménový YAML: `data/_source/domains/traffic_law/domain.yaml`,
     - subdomény: `data/_source/domains/traffic_law/subdomains.yaml` (volitelně),
     - intent zdroje: buď:
       - jednotlivé JSONy `data/_source/domains/traffic_law/intents/*.json`, nebo
       - fallback na jeden YAML `intents.yaml` (pokud existuje).
8. Ošetřit situaci, kdy adresář `data/_source/domains/&lt;domain&gt;/intents/` existuje, ale je prázdný nebo není – generátor musí dříve selhat s jasnou chybou:
   - např. `ValueError(&quot;No intent source files found for domain &#x27;traffic_law&#x27; in ...&quot;)` místo `FileNotFoundError` na konkrétní soubor, který neexistuje.

### 4.4 Vytvoření/obnovení `data/intents/**` a validace

9. Nastavit cílové umístění generovaných JSONů:
   - doporučení: `data/intents/&lt;domain&gt;/&lt;intent_id&gt;.json`
   - generátor a loader jsou pak konzistentní (loader rekurzivně čte vše).
10. Spustit generátor po opravách a následně:
    - spustit `tools/validate_intents.py` a doplnit jeho logiku tak, aby:
      - kontroloval přítomnost povinných polí,
      - upozornil na doménu bez intentů,
      - validoval alespoň základní strukturu `keywords`/`negative_keywords`.
11. V případě historických JSONů v `data/intents/**` (až se objeví):
    - projít je, zda nejsou ve starém formátu (např. `id` bez `intent_id`, bez `domain`),
    - případně přidat do `_normalize_raw()` mapování z dalších starších klíčů nebo vytvořit jednorázový migrační skript.

### 4.5 Dokumentace a testy

12. V `docs/intent.system.md` a `docs/README_datova_architektura.md`:
    - vypsat jasný datový tok:
      - `data/_source/domains/**` → `tools/generate_intents_from_domains.py` → `data/intents/**` → `engines/intent/loader` → `IntentDefinition`.
    - jednoznačně definovat povinná a volitelná pole pro runtime intent JSON.
13. Přidat/rozšířit testy:
    - unit test pro `_normalize_raw()` s:
      - minimálním JSONem (bez množiny polí),
      - JSONem se starými klíči (`id`, `intent_group`, `examples`),
      - plným JSONem s kompletní strukturou.
    - integrační test pro `generate_intents_from_domains.py`:
      - test pro konkrétní doménu (např. `traffic_law`) s fixním obsahem v `data/_source/domains/traffic_law/**`,
      - kontrola, že se v `data/intents/traffic_law/` objeví očekávané soubory a že `load_intents()` je bezchybně načte.

---

## 5. Co není jasné / co chybí

Aby bylo možné opravit věci přesně, chybí mi:

1. **Obsah `tools/generate_intents_from_domains.py`**  
   - konkrétní logika hledání doménového YAML/JSON a intent zdrojů,  
   - konkrétní error/traceback při běhu s `--domain traffic_law`.

2. **Obsah `tools/validate_intents.py`**  
   - jaká pravidla validační skript vynucuje (schema, tipech dat, povinných polích).

3. **Ukázkový reálný JSON v `data/intents/**`** (pokud existují lokálně, ale nebyly v dumpu)  
   - abych viděl, jaký formát byl v praxi používán a kde přesně vznikaly chyby typu „unexpected keyword &#x27;examples&#x27;“.

4. **Obsah doménových YAML (`domain.yaml`, `subdomains.yaml`) pro `traffic_law`**  
   - abych věděl, jaká data (např. defaultní `domain`, `subdomains`) by měl generátor propisovat do každého intentu.

---

## 6. Konkrétní doporučené kroky (pro vývojáře)

1. Otevřít a vložit sem k analýze obsah:
   - `tools/generate_intents_from_domains.py`,
   - `tools/validate_intents.py`,
   - ukázkového generovaného (nebo ručně psaného) JSONu z `data/intents/**`.
2. Podle navrženého schématu v části 4:
   - sjednotit `IntentDefinition` a `_normalize_raw()` (pole, defaulty),
   - rozhodnout o budoucnosti `intent_group` a `examples`.
3. Upravit `generate_intents_from_domains.py` tak, aby:
   - fungoval s reálnou strukturou `data/_source/domains/traffic_law/**`,
   - ukládal výsledek do `data/intents/&lt;domain&gt;/...`.
4. Po opravě:
   - spustit generátor pro `traffic_law`,
   - spustit `tools/validate_intents.py` a opravit zjištěné nesrovnalosti v datech.
5. Dopsat testy pro:
   - normalizaci JSONů,
   - funkční generaci intentů z `traffic_law`.
6. Aktualizovat dokumentaci, aby nový datový tok a formát `IntentDefinition` byly jasné a jednoznačné.
================================================================================
</pre>
</body>
</html>
