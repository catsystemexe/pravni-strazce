<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <title>Právní strážce – poslední report agenta</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
    
        body {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            margin: 2rem;
            line-height: 1.5;
            background: #0f172a;
            color: #e5e7eb;
        }
        pre {
            white-space: pre-wrap;
            word-wrap: break-word;
            background: #020617;
            padding: 1.5rem;
            border-radius: 0.75rem;
            border: 1px solid #1f2937;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        h1 {
            font-size: 1.5rem;
            margin-bottom: 1rem;
        }
        .meta {
            font-size: 0.85rem;
            color: #9ca3af;
            margin-bottom: 0.5rem;
        }

    </style>
</head>
<body>
    <h1>Právní strážce – poslední report agenta</h1>
    <div class="meta">
      Tento soubor generuje GitHub Action z repozitáře catsystemexe/pravni-strazce.
    </div>
    <pre>================================================================================
ODPOVĚĎ CODING AGENTA:

## 1. Co z projektu chápu

- Jádro je právní pipeline (`runtime/orchestrator.run_pipeline`), která:
  - přijme dotaz,
  - přes intent engine určí intent/doménu,
  - přes core_legal engine vytvoří právní IRAC skeleton,
  - přes risk/judikaturu/safety/output poskládá finální odpověď.

- Domény a intents:
  - Doménová pravidla (spíše high‑level) jsou v `engines/domain_rules/*.yaml`.
  - Detailní právní doménová data + intents jsou v `data/_source/domains/**` – např. traffic_law má:
    - `domain.yaml`, `subdomains.yaml`,
    - několik konkrétních intent JSONů pro přestupky rychlosti.
  - Intent engine ale čte pouze `data/intents/*.json` přes `engines/intent/loader.py`.
    - `IntentDefinition` má bohaté schéma (keywords, safety_questions, conclusion_skeletons atd.).
    - Loader očekává finalizované JSONy v `data/intents`, ne `_source`.
  - V `tools/` jsou utility pro generování intentů z domén (`generate_intent_from_domains.py`, `generate_intents_from_yaml.py`, `bootstrap_traffic_law_intents.py`) – tedy existuje plánovaný „build“ krok z `_source` → runtime intents.

- LLM:
  - `llm/client.py` poskytuje jednotný `LLMClient` a volbu modelu podle `use_case`.
  - Intent engine má fallbackový LLM doplněk (když je confidence nízká), ale zatím používá inline system prompt, ne šablonu z `engines/intent/prompts/intent_classification.md`.

- Dokumentace:
  - `docs/intent.system.md`, `docs/domain_catalog.md`, `docs/domain_map_traffic_law.md`, `docs/README_datova_architektura.md` popisují koncepty, ale jejich obsah tu nevidím.

- Produktová vrstva:
  - `product/e_advokat_pro/*.yaml` – produktové nastavení (risk policy, licensing) oddělené od core.

Celkově: existují tři „patra“ pro intents/domény:
1. `_source` (doménové yaml/json) – lidsky udržovatelná pravda.
2. build nástroje v `tools/` – generují runtime datové struktury (intents).
3. runtime struktury – `data/intents/*.json` + `engines/intent.*`.


---

## 2. Co mi chybí / není jasné

1. **Aktuální stav adresáře `data/intents`**  
   - Ve výpisu repa žádné `data/intents` nevidím.  
   - Intent engine ale očekává, že tam JSONy jsou.  
   → Není jasné, zda:
   - existuje generovací krok (např. `make build-intents`), který vytváří `data/intents` z `_source`,  
   - jak přesně vypadá cílový JSON formát (máme jen `_source` příklady a `_template/intent_template.json`).

2. **Obsah `docs/intent.system.md` a datového template**  
   - Potřeboval bych vidět:
     - jaká je oficiální minimální/ideální struktura intentu,
     - jak se mají mapovat `_source/domains/*` na `IntentDefinition`.

3. **Jak je nyní intent engine zapojen v pipeline**  
   - Soubor orchestrace (`runtime/orchestrator.py`) tu nemám, takže nevidím:
     - jak se výstup intent enginu propisuje do `core_legal` (meta.domain/meta.intent),
     - jestli se používají subdomény, intent_group, risk_patterns atd.

4. **Bootstrap proces pro konkrétní doménu (traffic_law)**  
   - Existuje `tools/bootstrap_traffic_law_intents.py` a `docs/domain_map_traffic_law.md`, ale neznám jejich obsah.
   - Není jasné, zda už proběhl bootstrap do `data/intents`, nebo se teprve plánuje.

---

## 3. Návrh konkrétních kroků – zaměřeno na „bootstrap intent“ a architekturu

### 3.1 Jasně oddělit _source → runtime → engine (pipeline pro intents)

1. **Zavést (nebo formalizovat) build krok pro intents**
   - Cíl: standardizovaný proces:
     - vstup: `data/_source/domains/**`,
     - výstup: `data/intents/*.json` přesně odpovídající `IntentDefinition`.
   - Doporučení:
     - Vytvořit v kořeni `Makefile` nebo `tools/BUILD.md` s příkazem např.:
       - `python tools/generate_intents_from_yaml.py --out data/intents`.
     - V README doplnit sekci „Jak bootstrapnout intents“:
       - „Spusťte `python tools/bootstrap_traffic_law_intents.py`, pak `python tools/validate_intents.py`“.

2. **Zkonzolidovat generovací nástroje v `tools/`**
   - Zrevidovat `generate_intent_from_domains.py`, `generate_intents_from_yaml.py`, `bootstrap_traffic_law_intents.py`, `fix_intent_pipeline_v1.py`, `fix_create_intent_runtime_dirs.py` a:
     - Definovat jeden hlavní skript:
       - `tools/build_intents.py` – orchestruje:
         1. načtení domén z `_source`,
         2. validaci proti `data/schema/domains.json` (pokud dává smysl),
         3. generování do `data/intents`,
         4. spuštění `tools/validate_intents.py`.
     - Ostatní skripty označit jako legacy nebo je interně používat z nového orchestrátoru.

3. **Doplnit/ujasnit runtime umístění intents**
   - Ve `engines/intent/loader.py` je `BASE_DIR = os.path.join(&quot;data&quot;, &quot;intents&quot;)`.  
   - Doporučení:
     - V `docs/intent.system.md` jasně napsat:
       - `data/_source/**` = zdroj,
       - `data/intents/**` = build artefakt (nemusí se committovat, nebo ano, ale je „odvozený“).
     - Pokud má být `data/intents` verziovaný, přidat krátké vysvětlení, jak ho regenerovat při změně `_source`.

---

### 3.2 Úprava IntentDefinition a loaderu – zarovnání se _source

4. **Sjednotit schéma IntentDefinition s template a _source**
   - Aktuální `IntentDefinition` obsahuje:
     - povinné: `intent_id, label_cs, domain, description_cs, subdomains, keywords, negative_keywords, risk_patterns, basic_questions, safety_questions, normative_references, conclusion_skeletons`;
     - volitelné: `notes, version, intent_group, examples`.
   - Loader `_normalize_raw`:
     - maže `intent_group`, ale dataclass ho zase definuje – to je rozpor.
   - Konkrétní změny:
     1. Rozhodnout, zda `intent_group` a `examples` mají být součást IntentDefinition:
        - podle enginu se `intent_group` používá k výstupu → ano, zachovat.
     2. Upravte `_normalize_raw`:
        - nemazat `intent_group`,
        - do `valid_fields` přidat `&quot;examples&quot;`, pokud chcete příklady i v runtime.
     3. Vytvořit/aktualizovat `data/_source/_template/intent_template.json` tak, aby:
        - přesně odpovídal `IntentDefinition`,
        - označil, co je „required“, co je „recommended“.

5. **Dočasné fallbacky pro nekompletní intents (pro bootstrap fázi)**
   - Aby bootstrap byl snadnější, můžete v `_normalize_raw` doplnit:
     - `subdomains` default na `[]`,
     - `risk_patterns` default na `[]`,
     - `basic_questions`, `safety_questions`, `normative_references` default na `[]`,
     - `conclusion_skeletons` default na `{}`.
   - Tím bude možné generovat první vlnu intents jen s:
     - `intent_id, label_cs, domain, description_cs, keywords`.

---

### 3.3 Využití existence domény traffic_law (konkrétní bootstrap kroky)

6. **Definovat „bootstrap scénář“ pro traffic_law jako vzor**

   Navržený minimální postup:

   1. Vzít existující `_source` soubory:
      - `data/_source/domains/traffic_law/domain.yaml`,
      - `data/_source/domains/traffic_law/subdomains.yaml`,
      - `data/_source/domains/traffic_law/intents/*.json`.
   2. Ověřit, jak se tyto intent JSONy liší od `IntentDefinition`:
      - použít `tools/validate_intents.py` proti IntentDefinition (případně upravit validátor, aby načítal `_source` a hlásil rozdíly).
   3. Upravit `tools/bootstrap_traffic_law_intents.py` tak, aby:
      - načetl traffic_law `_source`,
      - pro každý `_source` intent:
        - doplnil chybějící pole podle template,
        - vygeneroval `keywords` z textu label/description (na začátek – ručně se pak doplní),
        - vytvořil `intent_id` ve formátu `traffic_speed_offense_*` apod., pokud ještě není,
      - zapsal výsledek do `data/intents/traffic_law/*.json`.
   4. Spustit demo s dotazy na dopravní přestupky a sledovat:
      - výstup intent enginu (`intent`, `domain`, `keywords`, `confidence`),
      - výstup `core_legal` (meta.domain/meta.intent – jestli to používá).

7. **Přidat dokument „Bootstrap nové domény“**
   - Např. `docs/bootstrap_intents.md`:
     - kroky:
       1. založ doménu v `data/_source/domains/&lt;domain_name&gt;`,
       2. vyplň `domain.yaml` a `subdomains.yaml`,
       3. vytvoř jeden nebo více `_source/intents/*.json` podle template,
       4. spusť `python tools/build_intents.py --domain &lt;domain_name&gt;`,
       5. spusť `pytest tests/test_generate_intents_from_yaml.py tests/test_runtime_pipeline.py`,
       6. otestuj dotazy v `demo.py`.

---

### 3.4 Zapojení promptu pro LLM intent classification

8. **Použít šablonu `engines/intent/prompts/intent_classification.md`**

   Aktuálně:
   - V `engine.py` je system prompt natvrdo ve stringu.

   Doporučené kroky:

   1. Vytvořit malý loader pro prompt:
      - buď v `engines/intent/engine.py` nebo samostatně `engines/intent/prompts/__init__.py`:

        ```python
        from pathlib import Path

        PROMPT_PATH = Path(__file__).with_name(&quot;intent_classification.md&quot;)

        def load_intent_prompt() -&gt; str:
            return PROMPT_PATH.read_text(encoding=&quot;utf-8&quot;)
        ```

   2. V `_heuristic_classify` nic neměnit; upravit část s LLM:

      ```python
      from .prompts import load_intent_prompt  # if extracted

      ...

      system_prompt = load_intent_prompt()
      ```

   3. Do promptu přidat popis existujících intentů/domén:
      - buď formou seznamu `intent_id → label_cs → domain` (dynamicky vkládaného do promptu),
      - nebo alespoň popis „Jak má LLM strukturovaně odpovědět“ (JSON schema).

   4. Definovat nový `use_case` v `llm/client.py`:
      - například `use_case=&quot;intent_classification&quot;` a v `get_llm_params_for_use_case` přidat branch:
        - model: helper_model,
        - max_tokens: nízké (200–400),
        - temperature: 0.1.

9. **Zpřesnit využití LLM výstupu**
   - Dnes `llm_raw` je jen string, nezpracovaný.
   - Minimální bootstrap:
     - nechat ho jako string v payload, ale:
       - definovat v dokumentaci, jak ho má budoucí verze parsovat (např. JSON s `intent_id`, `domain`, `confidence`).
   - Další krok (až bude stabilní pipeline):
     - pokud heuristika má `confidence &lt; X` a LLM výstup je validní JSON se silnějším skóre, přepsat hlavní `intent`/`domain` podle LLM.

---

### 3.5 Dokumentace a validace

10. **Zpřesnit dokumentaci „intent systém“**
    - Do `docs/intent.system.md` (nebo nového souboru):
      - UML/ER diagram pro `IntentDefinition`,
      - vysvětlit:
        - rozdíl `_source intent` vs `runtime intent`,
        - jak se využívají pole:
          - `risk_patterns` – navázání na `engines/risk`,
          - `safety_questions` – navázání na `engines/safety`,  
          - `conclusion_skeletons` – navázání na `engines/core_legal` (conclusion).

11. **Rozšířit testy pro intent bootstrap**
    - V `tests/test_generate_intents_from_yaml.py`:
      - přidat test, který:
        - vytvoří malý `_source` domain+intent fixture v dočasném adresáři,
        - spustí generátor intents,
        - ověří, že:
          - výsledné JSONy lze načíst přes `load_intents()`,
          - všechny potřebné fieldy odpovídají `IntentDefinition`.
    - V `tests/test_runtime_pipeline.py`:
      - doplnit parametrizované dotazy pro traffic_law (rychlost, pásy, alkohol) a ověřit, že:
        - `intent_engine.payload[&quot;domain&quot;] == &quot;traffic_law&quot;` (nebo jiný doménový identifikátor),
        - `confidence &gt; 0` a `matched_keywords` obsahují očekávané fráze.

---

## 4. Shrnutí minimálních kroků pro „Bootstrap intent“

1. Ujasnit a zdokumentovat: `_source` → `data/intents` → `IntentDefinition`.
2. Opravit `IntentDefinition` + `_normalize_raw` tak, aby byly konzistentní s template a podporovaly `intent_group`, `examples`.
3. Zprovoznit generátor intents pro jednu doménu (traffic_law) pomocí `tools/bootstrap_traffic_law_intents.py` nebo nového `build_intents.py`.
4. Přidat build krok do dokumentace / Makefile („jak spustit bootstrap“).
5. Zapojit šablonu `intent_classification.md` do LLM části intent enginu a definovat `use_case=&quot;intent_classification&quot;`.
6. Rozšířit testy o kontrolu, že po bootstrapu se traffic_law intents reálně používají v pipeline.

Pokud pošleš obsah:
- `data/_source/_template/intent_template.json`,
- jednoho `_source` intentu (např. `traffic_speed_offense_generic.json`),
- `docs/intent.system.md`,

mohu navrhnout přesný formát generovaného runtime intentu a konkrétní změny v `loader.py` a generovacích skriptech.
================================================================================
[fix_create_intent_runtime_dirs] Ensured runtime dirs in: /home/runner/work/pravni-strazce/pravni-strazce/data/intents
  - school_law
  - debt_law
  - environmental_law
  - property_construction_law
  - social_law
  - media_ip_law
  - constitutional_law
  - family_law
  - data_digital_law
  - labor_law
  - health_law
  - tax_law
  - administrative_law
  - inheritance_law
  - criminal_law
  - traffic_law
  - corporate_law
  - civil_law
  - consumer_finance_law
  - international_law
</pre>
</body>
</html>
