<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <title>Právní strážce – poslední report agenta</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
    
        body {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            margin: 2rem;
            line-height: 1.5;
            background: #0f172a;
            color: #e5e7eb;
        }
        pre {
            white-space: pre-wrap;
            word-wrap: break-word;
            background: #020617;
            padding: 1.5rem;
            border-radius: 0.75rem;
            border: 1px solid #1f2937;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        h1 {
            font-size: 1.5rem;
            margin-bottom: 1rem;
        }
        .meta {
            font-size: 0.85rem;
            color: #9ca3af;
            margin-bottom: 0.5rem;
        }

    </style>
</head>
<body>
    <h1>Právní strážce – poslední report agenta</h1>
    <div class="meta">
      Tento soubor generuje GitHub Action z repozitáře catsystemexe/pravni-strazce.
    </div>
    <pre>================================================================================
ODPOVĚĎ CODING AGENTA:

### 1. Co chápu ze struktury projektu

- Jádro je **pipeline** v `runtime/orchestrator.py`, kterou volají:
  - CLI (`api/cli.py`),
  - demo (`demo.py`),
  - případně budoucí HTTP server (`api/http_server.py`).
- Nad dotazem uživatele běží více **enginů**:
  - `core_legal` – IRAC analýza, doména, závěr.
  - `intent` – klasifikace na základě JSONů v `data/intents/**`.
  - `judikatura`, `risk`, `safety`, `output` atd.
- **Intenty/domény**:
  - Datové zdroje pro runtime v `data/intents/**` a `data/schema/domains.json`.
  - Zdrojová „master“ definice domén v `data/_source/domains/**` (např. dopravní právo má rozpad do subdomén a intents).
  - Nástroje v `tools/` generují/validují intent JSONy a domény, včetně:
    - `validate_intents.py`, `generate_intents_from_yaml.py`, `generate_intent_from_domains.py`,
    - a nově `validate_runtime_intents.py`, který má ověřovat konzistenci runtime-intentů.
- Kromě toho jsou:
  - **produktové konfigurace** (`product/e_advokat_pro/*.yaml`),
  - **packs** (balíčky domén/feature setů),
  - **šablony odpovědí** (`templates/answers/*.md`) a dokumentů.

---

### 2. Nemohu spustit `python tools/validate_runtime_intents.py`

Jako asistent nemám přístup k shellu ani k běhu Python skriptu v reálném prostředí repozitáře, takže:

- **Nemohu skutečně provést** `python tools/validate_runtime_intents.py`.
- Nemohu tedy vrátit *reálný runtime výstup* skriptu; mohu jen:
  - nahlédnout do kódu skriptu (zde ale není jeho obsah přiložen),
  - odhadnout, co validuje (podle názvu a okolní architektury),
  - navrhnout, jak ho spustit lokálně a jak výstup zpracovat do reportu.

K úplnému splnění úkolu mi chybí:

- Obsah souboru `tools/validate_runtime_intents.py`.
- Informace, v jakém prostředí to běží (požadovaná verze Pythonu, aktivní virtuální prostředí, proměnné prostředí).

Pokud chcete, zkuste doplnit obsah `tools/validate_runtime_intents.py`; pak mohu:
- přesně popsat, co validátor kontroluje,
- navrhnout strukturu reportu nad jeho výsledky,
- navrhnout vylepšení architektury intentů/domén podle těch validací.

---

### 3. Jak spustit `tools/validate_runtime_intents.py` lokálně a získat výstup

Pro vývojáře (konkrétní kroky):

1. V kořeni repozitáře spusťte (v aktivním virtuálním prostředí):
   ```bash
   cd /cesta/k/repozitari
   python tools/validate_runtime_intents.py &gt; out/validate_runtime_intents_report.txt
   ```
   - Pokud `out/` neexistuje, vytvořte jej předem:
     ```bash
     mkdir -p out
     ```

2. Ověřte **exit code**:
   ```bash
   echo $?
   ```
   - `0` = validace prošla.
   - `!=0` = validace našla chyby nebo skript spadl.

3. Zkopírujte obsah `out/validate_runtime_intents_report.txt` do
   - buď do `out/last_report.md` (pokud má sloužit jako hlavní report),
   - nebo vytvořte nový soubor `out/validate_runtime_intents_report.md` a použijte Markdown.

4. Pokud chcete, aby se report generoval standardně v Markdown, můžete:
   - obalit volání skriptu pomocným wrapperem (např. `tools/render_report_to_html.py` už umí renderovat data-reporty; případný další krok je napojit validátor na systém reportů).

---

### 4. Návrhy zlepšení architektury kolem runtime intentů a validace

#### 4.1. Zpřesnit roli `validate_runtime_intents.py` v dokumentaci

1. Do `docs/intent.system.md` doplňte sekci:
   - „Validace runtime-intentů“:
     - co přesně `validate_runtime_intents.py` kontroluje (např. strukturu JSON, vazbu na doménový katalog, duplicity, prázdné keywords),
     - jaký je rozdíl oproti `tools/validate_intents.py` a `tools/validate_data.py`.

2. Do `README.md` (nebo `docs/README_datova_architektura.md`) přidejte:
   - krátký „Data QA pipeline“:
     ```text
     - validate_data.py            → globální konzistence dat
     - validate_intents.py         → schéma a logika intentů (master)
     - validate_runtime_intents.py → konzistence runtime JSONů v data/intents/**
     ```

#### 4.2. Sladit `IntentDefinition` vs. normalizaci loaderu

Teď je nesoulad:

- `IntentDefinition` v `engines/intent/definition.py` má pole:
  - povinná: `intent_id`, `label_cs`, `domain`, `description_cs`, `subdomains`, `keywords`, `negative_keywords`, `risk_patterns`, `basic_questions`, `safety_questions`, `normative_references`, `conclusion_skeletons`,
  - s defaulty: `notes`, `version`, `intent_group`, `examples`.
- `_normalize_raw` v `loader.py`:
  - explicitně odstraňuje `intent_group` z raw JSONu:
    ```python
    if &quot;intent_group&quot; in raw:
        raw.pop(&quot;intent_group&quot;)
    ```
  - ale `IntentDefinition` má `intent_group: str = &quot;general&quot;`.

Důsledky:

- Runtime engine (`engines/intent/engine.py`) používá `getattr(intent_def, &quot;intent_group&quot;, None)` – tj. s JSONy nikdy nepracuje s per-intent group z dat, vždy jen s defaultem `&quot;general&quot;`, protože loader groupy zahazuje.
- `validate_runtime_intents.py` (pravděpodobně) může upozorňovat na nesrovnalosti nebo chybějící group/notes.

Návrh kroků:

1. Rozhodnout, kde se **pravda** o `intent_group` nachází:
   - buď v kódu (default `&quot;general&quot;`) – pak nemá smysl group v JSONu vůbec podporovat,
   - nebo v datech (`data/_source/**` → generované runtime JSONy) – pak loader nemá group zahazovat.

2. Zvolíte-li „pravda v datech“ (doporučuji pro flexibilitu):
   - upravit `tools/validate_runtime_intents.py`, aby:
     - kontroloval přítomnost `intent_group` (pokud má být povinný),
     - validoval, že group patří mezi definované skupiny (např. `[&quot;info&quot;, &quot;action&quot;, &quot;urgent&quot;]`).
   - upravit `_normalize_raw`:
     ```python
     # místo odstraňování intent_group:
     # if &quot;intent_group&quot; in raw:
     #     raw.pop(&quot;intent_group&quot;)
     # → tento blok odstranit
     ```
   - případně doplnit schéma pro intent JSONy, které povoluje `intent_group`.

3. Pokud zvolíte „pravda v kódu“:
   - odstranit `intent_group` z `IntentDefinition` úplně,
   - zajistit, aby `validate_runtime_intents.py` nekontroloval group v JSONu,
   - aktualizovat dokumentaci, aby se o `intent_group` v datech nemluvilo.

#### 4.3. Převést validátor do testovacího běhu

1. Přidejte test, který zavolá validační funkce `validate_runtime_intents.py` (pokud obsahuje funkce) a ne pouze `if __name__ == &quot;__main__&quot;` kód:
   - např. v `tests/test_validate_runtime_intents.py`:
     ```python
     from tools import validate_runtime_intents

     def test_validate_runtime_intents():
         errors = validate_runtime_intents.run_checks()
         assert not errors, f&quot;Found runtime intent issues: {errors}&quot;
     ```
   - pokud skript zatím neumí funkcionální režim, je vhodné ho refaktorovat:
     - udělat `def run_checks() -&gt; List[str]` a `if __name__ == &quot;__main__&quot;:` jen pro CLI.

2. CI pipeline (GitHub Actions / jiný) může běžet `pytest`, čímž se validace stane povinnou součástí build procesu.

#### 4.4. Konsolidace mezi `data/_source/domains/**` a `data/intents/**`

Pravděpodobná role `validate_runtime_intents.py`:

- Kontrola, že každý intent v `data/intents/**` má konzistentní doménu:
  - tzn. `intent.domain` existuje v `data/schema/domains.json` nebo v `runtime/domain_catalog.py`.
- Kontrola, že `subdomains` (pokud používáte) odpovídají nějakému master seznamu (např. v `data/_source/domains/*/subdomains.yaml`).

Navržené kroky:

1. Do validátoru přidejte (pokud tam ještě nejsou) tyto kontroly:
   - `domain` každého intentu:
     - existuje jako `id` v `data/schema/domains.json`,
     - případně v `runtime/domain_catalog.py`.
   - `subdomains` každého intentu:
     - jsou definovány v příslušném `subdomains.yaml` (např. pro `traffic_law`).
   - žádné `intent_id` se neopakuje napříč doménami.

2. Do `docs/domain_catalog.md` doplňte:
   - odkaz na validátor a krátký snippet:
     ```bash
     # po úpravě domain.yaml / subdomains.yaml
     python tools/generate_intents_from_yaml.py
     python tools/validate_runtime_intents.py
     ```

3. Vytvořte jednoduchý **„lifecycle“** pro změnu domény/intentů (krátká sekce v dokumentaci):
   - uprav `data/_source/domains/...`,
   - vygeneruj runtime intent JSONy,
   - spusť validaci master (`validate_intents.py`) + runtime (`validate_runtime_intents.py`),
   - až pak merge do main.

#### 4.5. Výstup validátoru – formát a použitelnost v reportech

1. Ujistěte se, že `validate_runtime_intents.py`:
   - jasně rozlišuje:
     - `ERROR` (blokující problém – chybí povinné pole, invalidní JSON, neexistující doména),
     - `WARNING` (např. prázdné `keywords`, chybějící `notes`, nevyužité `subdomains`),
     - `INFO` (souhrn, počty intentů na doménu).
   - tiskne výstup v podobě, která jde snadno vložit do Markdown reportu:
     ```text
     [ERROR] traffic_speed_offense_generic.json: field &quot;domain&quot; not in schema
     [WARNING] ... 
     ```

2. Volitelně:
   - Upravte skript, aby uměl volbu `--format markdown`:
     ```bash
     python tools/validate_runtime_intents.py --format markdown &gt; out/validate_runtime_intents_report.md
     ```
   - Tím se zlepší integrace s nástrojem `tools/render_report_to_html.py`.

---

### 5. Co mi ještě chybí / co by bylo dobré doplnit

Abych mohl navrhnout ještě konkrétnější změny:

1. Obsah `tools/validate_runtime_intents.py`:
   - jaké funkce má,
   - jaké kontroly dělá,
   - zda používá schéma (např. `data/schema/domains.json`) nebo ruční kontroly.

2. Ukázku (aspoň jednoho) aktuálního JSON intentu z jiné domény než `traffic_law`:
   - např. `data/intents/labor_law/*.json`.
   - To umožní zkontrolovat konzistenci `IntentDefinition` vs. skutečná data.

3. Informaci, zda doménový katalog pro runtime je:
   - jediným zdrojem v `data/schema/domains.json`,
   - nebo se částečně duplikuje v `runtime/domain_catalog.py`.

Pokud tyto části doplníte, mohu:
- navrhnout přesný refaktoring validátoru,
- sjednotit datové typy mezi `IntentDefinition`, JSONy a schematy,
- navrhnout konkrétní strukturu výstupního **QA reportu pro runtime-intenty** (sekce, tabulky, filtry).
================================================================================
</pre>
</body>
</html>
