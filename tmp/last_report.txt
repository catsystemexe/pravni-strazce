================================================================================
ODPOVĚĎ CODING AGENTA:

## 1. Co chápu ze struktury projektu

### 1.1 Vysoká úroveň

- Projekt je **core backend framework** pro právního asistenta „Právní Strážce“.
- Architektura je modulární:
  - `runtime/` – orchestrátor, konfigurace, doménový katalog.
  - `engines/` – samostatné „enginy“ pro dílčí úlohy:
    - `core_legal` – IRAC analýza.
    - `intent` – klasifikace intentu a domény z dotazu.
    - `judikatura` – lookup judikatury.
    - `risk` – vyhodnocení rizika.
    - `safety` – PII guard, bezpečnost.
    - `domain_rules` – ruční pravidla podle právních domén.
    - `conclusion`, `questions`, `output`, `memory` atd. – další kroky pipeline.
  - `llm/` – jednotný LLM klient + konfigurace.
  - `api/` – CLI + skeleton HTTP vrstva.
  - `product/` a `packs/` – produktové konfigurace (feature flags, licensing, packy „family“, „civil“, „common“).
  - `templates/` – Markdown šablony pro dokumenty a odpovědi.
  - `prompts/` a `engines/*/prompts` – prompt šablony a policy prompty.
  - `tests/` – Pytesty pro runtime a vybrané enginy.

### 1.2 Datová vrstva pro právo

- `data/schema/domains.json` – základní schéma pro domény (master katalog).
- `data/_source/domains/*` – zdrojové podklady pro jednotlivé právní domény:
  - v některých doménách už existují konkrétní **intent JSON soubory** (např. `traffic_law/intents/traffic_speed_offense_*.json`).
  - u (např.) `traffic_law` i `domain.yaml`, `subdomains.yaml`, `readme.md` – koncept doménové definice.
- `data/_source/_template/intent_template.json` – vzorová definice intentu.
- `engines/intent` ale zatím čte intent definice z `data/intents/` (což v aktuálním výpisu není vidět – pravděpodobně generovaný/kompilovaný adresář).
- `engines/domain_rules/*.yaml` – ruční „doménová heuristika“ (spotřebitelské, školské, trestní, zdravotnické, správní, civilní, notářské, rodinné právo).
- `knowledge/legal_dictionary.md` – právní slovník / pojmy.

### 1.3 Intenty a jejich engine

- `engines/intent/definition.py` definuje `IntentDefinition` s poli:
  - `intent_id`, `label_cs`, `domain`, `description_cs`, `subdomains`,
  - `keywords`, `negative_keywords`,
  - `risk_patterns`, `basic_questions`, `safety_questions`,
  - `normative_references`, `conclusion_skeletons`,
  - doplňkové: `notes`, `version`, `intent_group`, `examples`.
- `engines/intent/loader.py`:
  - očekává soubory v `data/intents/**/*.json`.
  - `_normalize_raw` umí:
    - převést `id` → `intent_id`,
    - doplnit chybějící `keywords`/`negative_keywords`,
    - odstranit klíče nepatřící do whitelistu (ale whitelist NEZNÁ `intent_group` a `examples` – nesoulad s dataclass).
- `engines/intent/engine.py`:
  - cacheuje načtené intenty.
  - heuristicky klasifikuje dotaz podle `keywords`/`negative_keywords` (bez LLM).
  - určuje `intent`, `domain`, `intent_group`, `confidence`.
  - volitelně zapojí LLM při nízké jistotě (use_case `helper`, ale v LLM configu není přímo definován).

### 1.4 LLM vrstva, orchestrátor a šablony

- `llm/client.py` – jednotná abstrakce LLM:
  - backend: `mock` / `openai` podle env.
  - čte parametry z `llm/config.yaml` přes `runtime.config_loader.load_yaml`.
  - `get_llm_params_for_use_case` má use_casy: `jurisprudence_search`, ostatní -> `legal_analysis` (ale enginy předpokládají i jiné, např. `helper`).
- `runtime/orchestrator.py` (obsah není ve výpisu, ale z používání v `demo.py` a `api/cli.py`:
  - spouští pipeline.
  - skládá `final_answer` přes `engines/output` + šablony (`templates/answers/legal_answer_with_judikatura.md`).
- Šablony:
  - `templates/answers/legal_answer_with_judikatura.md` – struktura právní odpovědi.
  - `templates/documents/*` – generování právních dokumentů (zatím obecně).

### 1.5 Dokumentace

- `docs/domain_catalog.md`, `docs/domain_map_traffic_law.md` – popis domén.
- `docs/intent.system.md` – dokumentace systému intentů.
- `docs/README_datova_architektura.md` – datová architektura (pravděpodobně popis vztahu `_source` → generované `data/intents` atd.).

---

## 2. Schématický nákres architektury (textově)

### 2.1 Architektura runtime

```text
UŽIVATEL
  │   (dotaz – text)
  ▼
API VRSTVA
  - api.cli.main()
  - api.http_server (budoucí FastAPI/Flask)
  │
  ▼
RUNTIME ORCHESTRÁTOR (runtime.orchestrator.run_pipeline)
  │
  ├─► intent_engine           (engines/intent/engine.py)
  │      - načte IntentDefinition z data/intents/*
  │      - heuristika + LLM doplněk
  │      - vrátí: intent_id, domain, intent_group, confidence
  │
  ├─► core_legal_engine       (engines/core_legal/engine.py)
  │      - vstup: user_query + intent/domain z intent_engine
  │      - používá: 
  │          - domain_rules/* (YAML)
  │          - prompts/core_legal/*
  │      - výstup: IRAC struktura (issues, rules, analysis, conclusion)
  │
  ├─► judikatura_engine       (engines/judikatura/engine.py)
  │      - vstup: uživatelský dotaz + issues/rules
  │      - LLM use_case: jurisprudence_search
  │      - výstup: seznam judikátů + metadata
  │
  ├─► risk_engine             (engines/risk/engine.py)
  │      - vstup: case context + core_legal závěry
  │      - výstup: risk level, score
  │
  ├─► safety_layer            (engines/safety/*.py)
  │      - kontrola PII, právní bezpečnost, licence
  │
  ├─► memory_engine           (engines/memory/legal_memory_context.py)
  │      - případně ukládání kontextu, session info
  │
  └─► output_engine           (engines/output/modular_output.py)
         - vstup: všechny dílčí výstupy
         - používá templates/answers/*.md
         - skládá: final_answer (Markdown) + strukturovaný payload

  ▼
VÝSTUP
  - final_answer (Markdown)
  - metadata: domain, intent, risk, judikatura, jistota, apod.
```

### 2.2 Datová vrstva – domény a intenty

```text
data/_source/
  └── domains/
       ├── traffic_law/
       │    ├── domain.yaml            # definice domény (název, popis, vazby)
       │    ├── subdomains.yaml        # jemnější členění
       │    ├── readme.md              # popis, mapování na české právo
       │    └── intents/
       │         ├── traffic_speed_offense_police_stop.json
       │         ├── ... (další konkrétní situace)
       │
       ├── administrative_law/
       │    └── appeal_admin_decision.json
       ├── criminal_law/
       │    └── criminal_defense.json
       ├── labor_law/
       │    └── labor_termination.json
       └── ... (další domény)

data/schema/
  └── domains.json         # schéma domén, validace struktury

data/intents/              # (cílový kompilovaný adresář)
  ├── traffic_law/
  │    └── traffic_speed_offense_police_stop.json
  ├── criminal_law/
  │    └── criminal_defense.json
  └── ...                  # generováno z data/_source/domains/**

engines/domain_rules/
  ├── civil.yaml
  ├── trestni.yaml
  └── ...                  # ruční pravidla pro core_legal

engines/intent/
  ├── definition.py        # IntentDefinition schema
  ├── loader.py            # načtení a normalizace data/intents/**
  └── engine.py            # heuristická + LLM-based klasifikace
```

---

## 3. Konkrétní návrhy kroků (architektura, domény, intents, šablony)

### 3.1 Zarovnání datového modelu IntentDefinition vs. loader

1. **Upravit whitelist ve `_normalize_raw` tak, aby odpovídal `IntentDefinition`:**

   - Dnes `valid_fields` NEobsahuje:
     - `intent_group`
     - `examples`
   - Dopad: tyto klíče se při načítání zahodí, přestože dataclass je má → potenciální bug/nekonzistence.
   - Navrhované změny:
     - Do `valid_fields` přidat:
       - `"intent_group"`, `"examples"`.
     - Nebo naopak odstranit z `IntentDefinition` to, co nechcete v datových souborech (ale to by byl horší přístup – dataclass už se používá v enginech).

2. **Standardizovat minimální požadovaná pole v šabloně `intent_template.json`:**

   - Ověřit, zda `_source/_template/intent_template.json` obsahuje:
     - všechna povinná pole `IntentDefinition` (včetně `subdomains`, `risk_patterns`, `basic_questions`, `safety_questions`, `normative_references`, `conclusion_skeletons`).
   - Pokud ne, doplnit, nebo nastavit v loaderu rozumné defaulty (např. prázdné listy/dict).

3. **Doplnit jednoduchý JSON-schema nebo Pydantic validátor pro intenty:**

   - Cíl: chytit chyby v `data/_source/domains/**/intents/*.json` dříve, než se promítnou do běhu enginu.
   - Lze:
     - buď přidat `tools/validate_intents.py`, který spustí validaci dat vůči `IntentDefinition`.
     - nebo využít `pydantic` model, který nahraje JSON a provede validaci s lepšími chybovými hláškami.

### 3.2 Jednotná „kompilační pipeline“ pro domény a intenty

4. **Vyjasnit vztah `data/_source/domains/**` → `data/intents/**`:**

   - Aktuálně:
     - `engines/intent.loader` očekává `data/intents/...`.
     - V repozitáři jsou detailní intenty v `_source/domains/...`.
     - V `tools/` jsou skripty:
       - `generate_intents_from_domains.py`
       - `generate_intents_from_yaml.py`
     - Ale nikde není explicitní README, jak přesně pipeline funguje.
   - Navrhovaný postup:
     - Vytvořit **diagram datové pipeline** v `docs/README_datova_architektura.md`:
       ```text
       _source/domains/* → (generate_intents_from_domains.py) → data/intents/*
       data/schema/domains.json → (validate_data.py) → kontrola konzistence
       ```
     - V `README_datova_architektura.md` doplnit:
       - které skripty přesně spouštět (v jakém pořadí).
       - jaké vstupy/ výstupy čekat.
       - kde se řeší lokalizace (cz/en), pokud někdy přibude.

5. **Zavést „build“ krok pro data (např. make/poetry script):**

   - Např. příkaz `make build-data` nebo `python -m tools.generate_intents_from_domains`.
   - CI pipeline:
     - před testy spustit generování `data/intents` z `_source`.
     - následně spustit `tools/validate_intents.py` a `tools/validate_data.py`.

6. **Zavést centralizovaný „domain registry“ (pokud už není v `runtime/domain_catalog.py`):**

   - Tak, aby:
     - každý `intent.domain` byl validován proti seznamu domén v `data/schema/domains.json` a/nebo `runtime/domain_catalog`.
     - vyloučily se překlepy typu `"traffic_law"`, `"trafic_law"`, `"silnicni_pravo"` atd.
   - Vhodné napojit do validačních skriptů v `tools`.

### 3.3 Konsolidace doménových pravidel a intent domén

7. **Mapování mezi `engines/domain_rules/*.yaml` a `data/_source/domains/*`:**

   - Dnes existují dvě doménové vrstvy:
     - YAML soubory v `engines/domain_rules` (česky pojmenované: `civil.yaml`, `trestni.yaml`).
     - anglicky pojmenované složky v `_source/domains` (`civil_law`, `criminal_law`, `traffic_law`).
   - Navrhnout jasnou mapu:
     - Např. v `runtime/domain_catalog.py` mít strukturu typu:
       ```python
       DOMAIN_MAP = {
           "traffic_law": {
               "code": "traffic_law",
               "label_cs": "Dopravní právo",
               "rules_file": "engines/domain_rules/spravni.yaml",  # jen příklad
           },
           "criminal_law": {
               "code": "criminal_law",
               "label_cs": "Trestní právo",
               "rules_file": "engines/domain_rules/trestni.yaml",
           },
           ...
       }
       ```
   - Tím:
     - core_legal_engine může snadno podle `intent.domain` najít příslušná pravidla.
     - dokumentace „domény“ bude jednotná pro datovou i logickou vrstvu.

8. **Doplnit do `docs/domain_catalog.md` tabulku:**

   - sloupce: `domain_code`, `label_cs`, `source_dir (_source/domains/...)`, `rules_yaml (engines/domain_rules/...)`, příp. `notes`.
   - tím bude pro právníka/autora dat jasné, kde co má udržovat.

### 3.4 LLM use cases & prompts

9. **Standardizovat `use_case` hodnoty v LLM vrstvě:**

   - `llm/client.get_llm_params_for_use_case` zná:
     - `"jurisprudence_search"` → helper model.
     - vše ostatní → `"legal_analysis"`.
   - Kód aktuálně používá i:
     - `"helper"` (v intent enginu, TODO poznámka).
   - Návrh:
     - Rozšířit `config.yaml` o:
       ```yaml
       use_cases:
         legal_analysis:
           model: "gpt-4.1-mini"
           temperature: 0.2
           max_tokens: 2000
         helper:
           model: "gpt-4.1-mini"
           temperature: 0.1
           max_tokens: 800
         jurisprudence_search:
           model: "gpt-4.1-mini"
           temperature: 0.1
           max_tokens: 800
       ```
     - A v `get_llm_params_for_use_case` přejít na obecné čtení `use_cases[use_case]` s fallbackem, místo ručního if/else.

10. **Napojit `engines/intent/prompts/intent_classification.md` na LLM volání:**

    - Dnes je v `engine.py` TODO „ideálně načíst prompt z intent_classification.md“.
    - Krok:
      - Přidat malý helper v `engines/intent/engine.py`:
        ```python
        from runtime.config_loader import load_text

        def _load_intent_prompt() -> str:
            return load_text("engines/intent/prompts/intent_classification.md")
        ```
      - System prompt nahradit načtením z tohoto souboru.
    - Benefit:
      - ladění promptu je čistě datová operace (bez zásahu do kódu).

11. **Propagace „policy“ promptů:**

    - Už existuje `prompts/policy/*` (policy_intent_engine, policy_core_legal, policy_risk_engine, atd.).
    - Doporučuji:
      - Nastavit v `llm/client` mechanismus, kde každý engine může předat:
        - `system_prompt` = combination(base policy + konkrétní prompt).
      - Nebo v `runtime.config_loader` zavést helper:
        ```python
        def load_policy_prompt(engine_name: str) -> str:
            path = f"prompts/policy/policy_{engine_name}_engine.md"
        ```
      - a enginy pak skládají:
        ```python
        system_prompt = load_policy_prompt("intent") + "\n\n" + load_intent_prompt()
        ```

### 3.5 Šablony odpovědí a dokumentů

12. **Zpřesnit strukturu šablony `legal_answer_with_judikatura.md`:**

    - Cíl: mít konzistentní sloty:
      - shrnutí faktů,
      - kvalifikace (doména, intent, právní kvalifikace),
      - právní analýza (IRAC),
      - judikatura (citace, krátké shrnutí),
      - rizika/nejistoty,
      - doporučený postup/next steps,
      - upozornění na omezení (není individuální právní služba atd.).
    - Doporučení:
      - Do šablony vložit „placeholdery“ typu:
        - `{{summary}}`, `{{issues}}`, `{{rules}}`, `{{analysis}}`, `{{conclusion}}`, `{{judikatura}}`, `{{risk}}`, `{{next_steps}}`.
      - V `engines/output/modular_output.py` explicitně pracovat s těmito klíči ve vstupním payloadu.

13. **Vytvořit šablonový systém pro dokumenty na základě intentu:**

    - Např. u `traffic_law/traffic_speed_offense_admin_proceeding` lze časem vytvořit dokument:
      - námitky proti příkazu,
      - odvolání proti rozhodnutí správního orgánu.
    - Krok:
      - Rozšířit `IntentDefinition` o pole:
        ```json
        "document_templates": [
          {
            "id": "admin_appeal",
            "label_cs": "Odvolání proti rozhodnutí ...",
            "template_path": "templates/documents/traffic/admin_appeal.md"
          }
        ]
        ```
      - V `output`/jiném enginu pak podle intentu nabízet generování konkrétního dokumentu.

### 3.6 Testy, validace a dokumentace

14. **Rozšířit testy pro intent engine:**

    - Dnes je test na `tools/generate_intents_from_yaml.py`, `test_runtime_pipeline.py`, `test_core_legal_engine.py`.
    - Chybí:
      - test, že `engines/intent/loader.load_intents()` korektně načte minimálně jednu definici (po generaci dat).
      - test, který ověří, že při chybě v jednom JSONu se ostatní načtou (jak zamýšlí loader).
      - test pro `_heuristic_classify` – aspoň 1–2 scénáře (např. rychlost na dálnici → traffic_speed_offense*).

15. **Upřesnit dokumentaci intent systému v `docs/intent.system.md`:**

    - Jasně popsat:
      - strukturu `IntentDefinition` (včetně `intent_group`, `examples`, `risk_patterns`).
      - vztah `domain` → doménový katalog (`data/schema/domains.json`).
      - jak má právník postupovat při přidání nového intentu:
        1. vytvořit JSON v `data/_source/domains/<domain>/intents/...`.
        2. spustit generátor.
        3. spustit validační skripty.
        4. případně doplnit domain_rules Yaml, pokud je třeba.

16. **Explicitně popsat v `docs/README_datova_architektura.md` roli `engines/domain_rules`:**

    - Jaký je formát YAML souborů?
    - Jak je core_legal_engine interpretuje?
    - Jak se to vztahuje k intents (např. explicitní pravidla pro vybrané intenty / subdomény).

---

## 4. Co není jasné a co bych potřeboval doplnit

1. **Obsah a formát `data/intents/` (cílový adresář):**
   - V aktuálním výpisu tento adresář nevidím, ale loader ho očekává.
   - Otázky:
     - Generuje se `data/intents` z `_source/domains` skriptem `generate_intents_from_domains.py`?
     - Má output stejnou strukturu jako `_source` (per-domain složky), nebo je plochý?

2. **Detailní formát souborů v `engines/domain_rules/*.yaml`:**
   - Jak přesně vypadají pravidla? (např. patterny slov, explicitní odkazy na paragrafy?)
   - Jak je interpretuje `engines/core_legal/engine.py`? (např. scoring, mapping na IRAC sekce?)

3. **Obsah `runtime/orchestrator.py` a `runtime/domain_catalog.py`:**
   - Jak orchestrátor předává domény a intenty dál do enginů?
   - Jak je doménový katalog reprezentován (dict, dataclass, YAML -> Python)?

4. **Struktura `IntentDefinition` vs. `_source` soubory:**
   - Např. u `traffic_law/intents/*.json`:
     - odpovídají 1:1 `IntentDefinition` nebo mají bohatší strukturu?
     - používají se nějaké nested struktury (např. pro otázky, varianty scénářů)?

5. **Plánovaný scope pro „product/e_advokat_pro“ a „packs/*“:**
   - Jak mají ovlivňovat:
     - dostupné domény?
     - hloubku analýzy (např. PRO vs. FREE)?
     - úroveň rizik/throttling?

---

Pokud doplníš informace k bodům v části 4, můžu navrhnout přesnější refaktoring datových struktur (např. konkrétní JSON/YAML schémata) a vztah mezi intent enginem, doménovým katalogem a core_legal logikou.
================================================================================
